{% extends 'base.html' %}

{% block title %}Travel Plans - Travel Planning Platform{% endblock %}

{% block extra_css %}
<style>
    #destinationMap {
        height: 400px;
        border-radius: var(--border-radius);
        margin-bottom: 1.5rem;
    }
    .recommendation-card {
        transition: transform 0.3s;
    }
    .recommendation-card:hover {
        transform: translateY(-5px);
    }
    .recommendation-img {
        height: 160px;
        object-fit: cover;
    }
    .search-bar {
        position: relative;
        z-index: 100;
        margin-bottom: -40px;
    }
    .search-card {
        border-radius: 50px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    .search-results {
        max-height: 300px;
        overflow-y: auto;
    }
</style>
{% endblock %}

{% block content %}
<section class="py-5">
    <div class="container">
        <div class="row mb-4 align-items-center">
            <div class="col">
                <h1>Your Travel Plans</h1>
                <p class="text-muted">Organize your upcoming adventures</p>
            </div>
            <div class="col-auto">
                <a href="{{ url_for('planner.create_plan') }}" class="btn btn-primary">
                    <i class="fas fa-plus me-2"></i> New Trip
                </a>
            </div>
        </div>

        <!-- New Destination Search & Map Section -->
        <div class="row mb-5">
            <div class="col-12">
                <div class="card animate fade-in">
                    <div class="card-body p-0">
                        <div class="search-bar px-4 py-4">
                            <div class="search-card bg-white p-3">
                                <form id="destination-search-form" class="row g-2">
                                    <div class="col-md-9">
                                        <div class="input-group">
                                            <span class="input-group-text bg-transparent border-end-0">
                                                <i class="fas fa-search"></i>
                                            </span>
                                            <input type="text" id="destination-input" class="form-control border-start-0" 
                                                   placeholder="Search for a destination..." aria-label="Search destination">
                                        </div>
                                        <div id="search-results" class="search-results bg-white shadow rounded p-2 mt-1 d-none">
                                            <!-- Search results will appear here -->
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <button type="submit" class="btn btn-primary w-100">
                                            <i class="fas fa-compass me-1"></i> Explore
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                        <div id="destinationMap"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Travel Recommendations Section -->
        <div class="row mb-5">
            <div class="col-12">
                <h2 class="mb-3">Travel Recommendations</h2>
                <p class="text-muted mb-4">Personalized suggestions based on your interests and selected destination</p>
                
                <div class="row g-4" id="recommendations-container">
                    <div class="col-12 text-center py-5" id="recommendations-placeholder">
                        <i class="fas fa-globe-americas fa-3x text-muted mb-3"></i>
                        <h4>Search for a destination to see recommendations</h4>
                        <p class="text-muted">We'll suggest attractions, accommodations, and activities tailored to your preferences</p>
                    </div>
                    <!-- Recommendations will be inserted here via JavaScript -->
                </div>
            </div>
        </div>
        
        <!-- Existing Travel Plans Section -->
        <div class="row mb-4">
            <div class="col">
                <h2>Your Existing Plans</h2>
            </div>
        </div>
        
        <div class="row g-4">
            {% if plans %}
                {% for plan in plans %}
                    <div class="col-md-6 col-lg-4 animate fade-in" style="animation-delay: {{ loop.index0 * 0.1 }}s;">
                        <div class="card h-100">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h5 class="card-title mb-0">{{ plan.title }}</h5>
                                    {% if plan.is_public %}
                                        <span class="badge bg-info">Public</span>
                                    {% endif %}
                                </div>
                                <div class="d-flex align-items-center mb-2">
                                    <i class="fas fa-map-marker-alt text-danger me-2"></i>
                                    <span>{{ plan.destination }}</span>
                                </div>
                                <div class="d-flex align-items-center mb-2">
                                    <i class="fas fa-calendar text-primary me-2"></i>
                                    <span>{{ plan.start_date.strftime('%b %d') }} - {{ plan.end_date.strftime('%b %d, %Y') }}</span>
                                </div>
                                <div class="d-flex align-items-center mb-3">
                                    <i class="fas fa-money-bill-wave text-success me-2"></i>
                                    <span>Budget: ${{ plan.budget }}</span>
                                </div>
                                <p class="card-text small text-muted mb-3">
                                    {{ plan.interests or 'No interests specified' | truncate(100) }}
                                </p>
                                <div class="d-flex align-items-center small text-muted mb-3">
                                    <i class="fas fa-clock me-2"></i>
                                    <span>Created {{ plan.created_at.strftime('%b %d, %Y') }}</span>
                                </div>
                                
                                <div class="d-flex gap-2">
                                    <a href="{{ url_for('planner.view_plan', plan_id=plan.id) }}" class="btn btn-sm btn-primary">View Plan</a>
                                    <a href="{{ url_for('planner.edit_plan', plan_id=plan.id) }}" class="btn btn-sm btn-outline-primary">Edit</a>
                                    <div class="dropdown ms-auto">
                                        <button class="btn btn-sm btn-light" type="button" data-bs-toggle="dropdown">
                                            <i class="fas fa-ellipsis-v"></i>
                                        </button>
                                        <ul class="dropdown-menu dropdown-menu-end">
                                            <li><a class="dropdown-item" href="{{ url_for('planner.manage_itinerary', plan_id=plan.id) }}">Edit Itinerary</a></li>
                                            <li><a class="dropdown-item" href="{{ url_for('planner.share_plan', plan_id=plan.id) }}">Share</a></li>
                                            <li><hr class="dropdown-divider"></li>
                                            <li>
                                                <form action="{{ url_for('planner.delete_plan', plan_id=plan.id) }}" method="post" class="d-inline" onsubmit="return confirm('Are you sure you want to delete this travel plan?');">
                                                    <button type="submit" class="dropdown-item text-danger">Delete</button>
                                                </form>
                                            </li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                {% endfor %}
            {% else %}
                <div class="col-12">
                    <div class="alert alert-light text-center py-5 animate fade-in">
                        <i class="fas fa-plane-departure mb-4" style="font-size: 3rem;"></i>
                        <h3>No travel plans yet</h3>
                        <p class="mb-4">Start planning your next adventure!</p>
                        <a href="{{ url_for('planner.create_plan') }}" class="btn btn-primary">Create a New Trip</a>
                    </div>
                </div>
            {% endif %}
        </div>
    </div>
</section>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize the map
    const map = L.map('destinationMap').setView([20, 0], 2); // Default world view
    
    // Add tile layer (OpenStreetMap)
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
        maxZoom: 19
    }).addTo(map);
    
    // Current marker for searched location
    let currentMarker = null;
    
    // Handle form submission for destination search
    document.getElementById('destination-search-form').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const destination = document.getElementById('destination-input').value.trim();
        if (!destination) return;
        
        // Hide search results
        document.getElementById('search-results').classList.add('d-none');
        
        // Show loading state
        const button = this.querySelector('button[type="submit"]');
        const originalButtonText = button.innerHTML;
        button.disabled = true;
        button.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Loading...';
        
        // Geocode the address using Nominatim (OpenStreetMap)
        fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(destination)}`)
            .then(response => response.json())
            .then(data => {
                button.disabled = false;
                button.innerHTML = originalButtonText;
                
                if (data && data.length > 0) {
                    const location = data[0];
                    const lat = parseFloat(location.lat);
                    const lon = parseFloat(location.lon);
                    
                    // Update map
                    map.setView([lat, lon], 12);
                    
                    // Add or update marker
                    if (currentMarker) {
                        map.removeLayer(currentMarker);
                    }
                    
                    currentMarker = L.marker([lat, lon]).addTo(map)
                        .bindPopup(`<b>${location.display_name}</b>`)
                        .openPopup();
                    
                    // Fetch recommendations
                    fetchRecommendations(destination, lat, lon);
                } else {
                    alert('Location not found. Please try a different search term.');
                }
            })
            .catch(error => {
                button.disabled = false;
                button.innerHTML = originalButtonText;
                console.error('Error fetching location:', error);
                alert('An error occurred while searching for the location. Please try again.');
            });
    });
    
    // Function to fetch recommendations based on location
    function fetchRecommendations(destination, latitude, longitude) {
        const recommendationsContainer = document.getElementById('recommendations-container');
        const placeholder = document.getElementById('recommendations-placeholder');
        
        // Show loading state
        placeholder.innerHTML = `
            <div class="d-flex flex-column align-items-center">
                <div class="spinner-border text-primary mb-3" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <h4>Finding recommendations for ${destination}...</h4>
            </div>
        `;
        
        // Simulate fetching recommendations (in a real application, this would call your backend API)
        setTimeout(() => {
            // Sample recommendation categories
            const categories = ['Attractions', 'Accommodations', 'Food & Dining', 'Activities'];
            
            // Clear placeholder
            placeholder.classList.add('d-none');
            recommendationsContainer.innerHTML = '';
            
            // Generate recommendations for each category
            categories.forEach((category, index) => {
                recommendationsContainer.innerHTML += `
                    <div class="col-12 mb-4">
                        <h3>${category}</h3>
                        <div class="row g-3">
                            ${generateRecommendationItems(category, 3, index)}
                        </div>
                    </div>
                `;
            });
            
            // Add "Create Plan" button
            recommendationsContainer.innerHTML += `
                <div class="col-12 text-center mt-4">
                    <a href="${createPlanWithDestinationUrl(destination)}" class="btn btn-primary btn-lg">
                        <i class="fas fa-magic me-2"></i> Create Trip Plan for ${destination}
                    </a>
                </div>
            `;
        }, 1500);
    }
    
    // Function to generate recommendation items for each category
    function generateRecommendationItems(category, count, seedIndex) {
        let items = '';
        
        // Sample data for each category
        const attractions = [
            { name: 'Historic Downtown', rating: 4.8, image: 'https://source.unsplash.com/600x400/?landmark', price: '$' },
            { name: 'National Museum', rating: 4.7, image: 'https://source.unsplash.com/600x400/?museum', price: '$$' },
            { name: 'City Park', rating: 4.9, image: 'https://source.unsplash.com/600x400/?park', price: 'Free' }
        ];
        
        const accommodations = [
            { name: 'Grand Hotel', rating: 4.6, image: 'https://source.unsplash.com/600x400/?hotel', price: '$$$' },
            { name: 'Cozy B&B', rating: 4.5, image: 'https://source.unsplash.com/600x400/?bed-breakfast', price: '$$' },
            { name: 'City Apartments', rating: 4.3, image: 'https://source.unsplash.com/600x400/?apartment', price: '$$$' }
        ];
        
        const dining = [
            { name: 'Local Cuisine Restaurant', rating: 4.7, image: 'https://source.unsplash.com/600x400/?restaurant', price: '$$' },
            { name: 'Street Food Market', rating: 4.5, image: 'https://source.unsplash.com/600x400/?street-food', price: '$' },
            { name: 'Fine Dining Experience', rating: 4.9, image: 'https://source.unsplash.com/600x400/?fine-dining', price: '$$$' }
        ];
        
        const activities = [
            { name: 'Guided Walking Tour', rating: 4.5, image: 'https://source.unsplash.com/600x400/?tour', price: '$$' },
            { name: 'Boat Excursion', rating: 4.8, image: 'https://source.unsplash.com/600x400/?boat', price: '$$$' },
            { name: 'Local Cooking Class', rating: 4.7, image: 'https://source.unsplash.com/600x400/?cooking', price: '$$' }
        ];
        
        let data;
        switch(category) {
            case 'Attractions': data = attractions; break;
            case 'Accommodations': data = accommodations; break;
            case 'Food & Dining': data = dining; break;
            case 'Activities': data = activities; break;
            default: data = attractions;
        }
        
        for (let i = 0; i < count; i++) {
            items += `
                <div class="col-md-6 col-lg-4">
                    <div class="card recommendation-card h-100">
                        <img src="${data[i].image}" class="recommendation-img card-img-top" alt="${data[i].name}">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center mb-1">
                                <h5 class="card-title mb-0">${data[i].name}</h5>
                                <span class="badge bg-primary">${data[i].price}</span>
                            </div>
                            <div class="text-warning mb-2">
                                ${generateStars(data[i].rating)}
                                <small class="text-muted ms-1">${data[i].rating.toFixed(1)}</small>
                            </div>
                            <button class="btn btn-sm btn-outline-primary mt-2" onclick="addToItinerary('${data[i].name}')">
                                <i class="fas fa-plus me-1"></i> Add to Itinerary
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }
        
        return items;
    }
    
    // Generate star ratings
    function generateStars(rating) {
        let stars = '';
        const fullStars = Math.floor(rating);
        const halfStar = rating % 1 >= 0.5;
        
        for (let i = 0; i < 5; i++) {
            if (i < fullStars) {
                stars += '<i class="fas fa-star"></i>';
            } else if (i === fullStars && halfStar) {
                stars += '<i class="fas fa-star-half-alt"></i>';
            } else {
                stars += '<i class="far fa-star"></i>';
            }
        }
        
        return stars;
    }
    
    // Create Plan URL with destination parameter
    function createPlanWithDestinationUrl(destination) {
        return `{{ url_for('planner.create_plan') }}?destination=${encodeURIComponent(destination)}`;
    }
    
    // Function for adding items to itinerary (to be implemented)
    window.addToItinerary = function(itemName) {
        alert(`'${itemName}' will be added to your itinerary when you create a new plan.`);
    };
    
    // Autocomplete functionality for destination input
    const destinationInput = document.getElementById('destination-input');
    const searchResults = document.getElementById('search-results');
    let debounceTimeout;
    
    destinationInput.addEventListener('input', function() {
        const query = this.value.trim();
        
        clearTimeout(debounceTimeout);
        
        if (query.length < 3) {
            searchResults.classList.add('d-none');
            return;
        }
        
        debounceTimeout = setTimeout(() => {
            // Fetch location suggestions using Nominatim
            fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=5`)
                .then(response => response.json())
                .then(data => {
                    if (data && data.length > 0) {
                        searchResults.innerHTML = '';
                        data.forEach(location => {
                            const div = document.createElement('div');
                            div.className = 'p-2 border-bottom search-item';
                            div.style.cursor = 'pointer';
                            div.innerHTML = `
                                <i class="fas fa-map-marker-alt text-danger me-2"></i>
                                ${location.display_name}
                            `;
                            div.addEventListener('click', () => {
                                destinationInput.value = location.display_name;
                                searchResults.classList.add('d-none');
                            });
                            searchResults.appendChild(div);
                        });
                        searchResults.classList.remove('d-none');
                    } else {
                        searchResults.classList.add('d-none');
                    }
                })
                .catch(error => {
                    console.error('Error fetching suggestions:', error);
                });
        }, 500);
    });
    
    // Hide search results when clicking outside
    document.addEventListener('click', function(e) {
        if (!destinationInput.contains(e.target) && !searchResults.contains(e.target)) {
            searchResults.classList.add('d-none');
        }
    });
});
</script>
{% endblock %}
