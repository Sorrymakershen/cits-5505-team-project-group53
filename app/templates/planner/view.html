{% extends 'base.html' %}

{% block title %}{{ plan.title }} - Travel Planning Platform{% endblock %}

{% block extra_css %}
<style>
    .map-container {
        height: 400px;
        border-radius: var(--border-radius);
    }
    .itinerary-item {
        border-left: 3px solid var(--primary-color);
        padding-left: 1.5rem;
        position: relative;
        margin-bottom: 1.5rem;
        transition: all var(--transition-speed);
        margin-top: 1rem; 
    }
    .itinerary-item:first-child {
        margin-top: 2rem; 
    }
    .itinerary-item:hover {
        transform: translateX(5px);
    }
    .itinerary-item::before {
        content: '';
        position: absolute;
        left: -9px;
        top: 0;
        width: 15px;
        height: 15px;
        border-radius: 50%;
        background-color: var(--primary-color);
    }
    .itinerary-day {
        position: sticky;
        top: 70px;
        z-index: 2;
        margin-bottom: 2rem !important; 
        background-color: var(--bs-light);
        box-shadow: 0 3px 5px rgba(0,0,0,0.05);
        border-bottom: 2px solid var(--primary-color); 
        padding-bottom: 1rem !important; 
    }
    .day-container {
        padding-top: 1.5rem; 
    }
    .ai-recommendation {
        border: 1px solid rgba(0,0,0,.125);
        border-radius: var(--border-radius);
        padding: 1rem;
        padding-right: 0.75rem; 
        margin-bottom: 0.75rem;
        transition: all var(--transition-speed);
        position: relative;
    }
    .ai-recommendation:hover {
        box-shadow: 0 3px 10px rgba(0,0,0,.1);
        border-color: var(--primary-color);
    }
    .ai-badge {
        background-color: #8e44ad;
    }
    .recommendation-item {
        position: relative;
        padding-bottom: 2.5rem; /* Leave space for bottom buttons */
    }
    .btn-add-recommendation {
        position: absolute;
        bottom: 0.5rem;
        right: 0.5rem;
        z-index: 10;
        font-size: 0.8rem; /* Reduce button font size */
        padding: 0.25rem 0.5rem; /* Reduce button padding */
    }
    .day-selector {
        margin-bottom: 1rem;
    }
   
    .itinerary-content {
        flex: 1;
        min-width: 0; 
    }
    .itinerary-actions {
        display: flex;
        flex-direction: column;
        justify-content: flex-start;
        margin-left: 10px;
        min-width: 50px; 
    }
    @media (max-width: 767px) {
        .itinerary-actions {
            flex-direction: row;
            margin-left: 0;
            margin-top: 10px;
        }
        .itinerary-actions .btn + .btn {
            margin-top: 0;
            margin-left: 8px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-5" 
     data-plan-id="{{ plan.id }}" 
     data-plan-budget="{{ plan.budget or 0 }}"
     data-total-cost="{{ total_cost }}">
    <!-- Plan Header -->
    <div class="row mb-4">
        <div class="col-lg-8">
            <div class="d-flex align-items-center mb-2">
                <a href="{{ url_for('planner.index') }}" class="text-decoration-none me-3">
                    <i class="fas fa-arrow-left"></i> Back to Plans
                </a>
                {% if plan.is_public %}
                    <span class="badge bg-info">Public</span>
                {% endif %}
            </div>
            <h1 class="mb-2">{{ plan.title }}</h1>
            <div class="d-flex flex-wrap gap-4 text-muted mb-3">
                <div class="d-flex align-items-center">
                    <i class="fas fa-map-marker-alt text-danger me-2"></i>
                    <span>{{ plan.destination }}</span>
                </div>
                <div class="d-flex align-items-center">
                    <i class="fas fa-calendar text-primary me-2"></i>
                    <span>{{ plan.start_date.strftime('%b %d') }} - {{ plan.end_date.strftime('%b %d, %Y') }}</span>
                </div>
                <div class="d-flex align-items-center">
                    <i class="fas fa-money-bill-wave text-success me-2"></i>
                    <span>Budget: ${{ plan.budget }}</span>
                </div>
            </div>
            {% if plan.interests %}
                <p class="mb-4">
                    <strong>Interests:</strong> {{ plan.interests }}
                </p>
            {% endif %}
        </div>
        <div class="col-lg-4 text-lg-end mt-3 mt-lg-0">
            <div class="btn-group">
                <a href="{{ url_for('planner.edit_plan', plan_id=plan.id) }}" class="btn btn-outline-primary">
                    <i class="fas fa-edit me-1"></i> Edit
                </a>
                <a href="{{ url_for('planner.share_plan', plan_id=plan.id) }}" class="btn btn-outline-primary">
                    <i class="fas fa-share-alt me-1"></i> Share
                </a>
            </div>
        </div>
    </div>

    <!-- Main Content - Map & Budget + AI recommendations -->
    <div class="row">
        <!-- Map & Budget -->
        <div class="col-lg-8">
            <div class="row">
                <div class="col-lg-7 mb-4 animate fade-in">
                    <div class="card">                
                        <div class="card-body p-0">
                            <div id="planMap" class="map-container" data-items='{{ itinerary_items_json | tojson }}'>
                                <!-- Map will be inserted here by JavaScript -->
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-5 mb-4 animate fade-in" data-delay="0.2">
                    <div class="card">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h3 class="card-title">Budget Breakdown</h3>
                                <span class="fs-4">${{ total_cost }}</span>
                            </div>
                            
                            <div class="progress mb-4" style="height: 10px; border-radius: 5px;">
                                <div class="progress-bar" role="progressbar" data-width="{{(total_cost / plan.budget)* 100 if plan.budget else 0 }}" aria-valuemin="0" aria-valuemax="100"></div>
                            </div>
                            
                            <div class="d-flex justify-content-between small text-muted mb-4">
                                <span>Spent: ${{ total_cost }}</span>
                                <span>Budget: ${{ plan.budget }}</span>
                            </div>
                            
                            {% if categories %}
                                <h5>Expenses by Category</h5>
                                <div class="mb-4">
                                    {% for category, amount in categories.items() %}
                                        <div class="mb-2">
                                            <div class="d-flex justify-content-between mb-1">
                                                <span>{{ category }}</span>
                                                <span>${{ amount }}</span>
                                            </div>
                                            <div class="progress" style="height: 5px; border-radius: 5px;">
                                                <div class="progress-bar" role="progressbar" 
                                                     data-width="{{ (amount / total_cost) * 100 if total_cost else 0 }}"
                                                     aria-valuemin="0" aria-valuemax="100"></div>
                                            </div>
                                        </div>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- AI Recommendations Sidebar -->
        <div class="col-lg-4 mb-4">
            <div class="card animate fade-in" data-delay="0.3">
                <div class="card-body">
                    <div class="d-flex align-items-center mb-4 flex-wrap">
                        <h3 class="card-title mb-0">
                            <i class="fas fa-robot text-purple me-2"></i> AI Recommendations
                        </h3>
                        <span class="badge ai-badge">Gemini AI</span>
                    </div>

                    <!-- Day Selector -->
                    <div class="day-selector">
                        <label for="recommendationDay" class="form-label">Select day for recommendations:</label>
                        <select id="recommendationDay" class="form-select">
                            {% for i in range(1, (plan.end_date - plan.start_date).days + 2) %}
                                {% set current_date = plan.start_date + day_timedelta(i-1) %}
                                <option value="{{ i }}">Day {{ i }} - {{ current_date | datetime_format }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <button id="getRecommendations" class="btn btn-primary w-100 mb-3">
                        <i class="fas fa-lightbulb me-2"></i> Get Recommendations
                    </button>
                    
                    <!-- Loading Spinner -->
                    <div id="aiLoadingSpinner" class="text-center py-5 d-none">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">AI is generating personalized recommendations...</p>
                    </div>
                    
                    <!-- Error Message -->
                    <div id="aiErrorMessage" class="alert alert-danger d-none">
                        Error getting recommendations. Please try again later.
                    </div>
                    
                    <!-- Recommendations Container -->
                    <div id="aiRecommendations" class="mt-3"></div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Itinerary -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h2>Itinerary</h2>
                <a href="{{ url_for('planner.manage_itinerary', plan_id=plan.id) }}" class="btn btn-primary">
                    <i class="fas fa-plus me-1"></i> Add Activity
                </a>
            </div>
        </div>
    </div>
    
    {% if itinerary_by_day %}
        <div class="row">
            <div class="col-12">
                <div class="card animate fade-in" data-delay="0.3">
                    <div class="card-body p-4" id="itinerary-container">
                        {% for day, items in itinerary_by_day %}
                            <div class="mb-4 day-container">
                                <div class="bg-light rounded p-3 mb-3 itinerary-day">
                                    <h4 class="mb-0">Day {{ day }}: {{ day_timedelta(day-1, plan.start_date) | datetime_format }}</h4>
                                </div>
                                
                                {% for item in items %}
                                    <div class="itinerary-item animate fade-in" data-delay="{{ loop.index * 0.1 }}" id="item-{{ item.id }}">
                                        <div class="d-flex flex-column flex-md-row justify-content-between">
                                            <div class="itinerary-content">
                                                <h5>{{ item.activity }}</h5>
                                                {% if item.location %}
                                                    <div class="mb-2">
                                                        <i class="fas fa-map-marker-alt text-danger me-2"></i>
                                                        {{ item.location }}
                                                    </div>
                                                {% endif %}
                                                {% if item.cost %}
                                                    <div class="mb-2">
                                                        <i class="fas fa-money-bill-wave text-success me-2"></i>
                                                        ${{ item.cost }}
                                                    </div>
                                                {% endif %}
                                                {% if item.time %}
                                                    <div class="mb-2">
                                                        <i class="far fa-clock text-primary me-1"></i>
                                                        {{ item.time }}
                                                    </div>
                                                {% endif %}
                                                {% if item.notes %}
                                                    <p class="text-muted">{{ item.notes }}</p>
                                                {% endif %}
                                            </div>
                                            <div class="itinerary-actions">
                                                <button type="button" class="btn btn-sm btn-outline-primary edit-time-btn" 
                                                        data-item-id="{{ item.id }}" data-bs-toggle="tooltip" 
                                                        title="Set/edit time">
                                                    <i class="fas fa-clock"></i>
                                                </button>
                                                <button type="button" class="btn btn-sm btn-outline-danger mt-2 delete-item-btn"
                                                        data-item-id="{{ item.id }}" data-bs-toggle="tooltip"
                                                        title="Remove activity">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    {% else %}
        <div class="card animate fade-in" data-delay="0.3">
            <div class="card-body text-center py-5">
                <i class="fas fa-calendar-day fa-3x text-muted mb-3"></i>
                <h3>No itinerary items yet</h3>
                <p>Start planning your daily activities for this trip.</p>
                <a href="{{ url_for('planner.manage_itinerary', plan_id=plan.id) }}" class="btn btn-primary mt-3">
                    Add Activities
                </a>
            </div>
        </div>
    {% endif %}
</div>

<!-- Day and Time Editor Modal -->
<div class="modal fade" id="dayTimeEditorModal" tabindex="-1" aria-labelledby="dayTimeEditorModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="dayTimeEditorModalLabel">Edit Day & Time</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editDayTimeItemId">
                <div class="mb-3">
                    <label for="editDaySelect" class="form-label">Day</label>
                    <select id="editDaySelect" class="form-select">
                        {% for i in range(1, (plan.end_date - plan.start_date).days + 2) %}
                            {% set current_date = plan.start_date + day_timedelta(i-1) %}
                            <option value="{{ i }}">Day {{ i }} - {{ current_date | datetime_format }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="mb-3">
                    <label for="editVisitTime" class="form-label">Visit Time</label>
                    <input type="time" class="form-control" id="editVisitTime">
                    <div class="form-text">Set a specific time for this activity (optional)</div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveDayTimeBtn">Save Changes</button>
            </div>
        </div>
    </div>
</div>


<!-- Time Editor Modal (Potentially redundant now) -->
<div class="modal fade" id="timeEditorModal" tabindex="-1" aria-labelledby="timeEditorModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="timeEditorModalLabel">Set Visit Time</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editItemId">
                <div class="mb-3">
                    <label for="visitTime" class="form-label">Visit Time</label>
                    <input type="time" class="form-control" id="visitTime">
                    <div class="form-text">Set a specific time for this activity</div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveTimeBtn">Save</button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-labelledby="deleteConfirmModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteConfirmModalLabel">Confirm Deletion</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to remove this activity from your itinerary?</p>
                <input type="hidden" id="deleteItemId">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Delete</button>
            </div>
        </div>
    </div>
</div>

{% block extra_js %}
<script>
    // Get plan data from container data attributes
    const container = document.querySelector('.container.py-5');
    const PLAN_ID = container.dataset.planId;
    const PLAN_BUDGET = parseFloat(container.dataset.planBudget);
    const TOTAL_COST = parseFloat(container.dataset.totalCost);

    // Function URLs
    const DELETE_ITINERARY_ITEM_URL = `/planner/${PLAN_ID}/delete_itinerary_item`;
    const UPDATE_ITEM_TIME_URL = `/planner/${PLAN_ID}/update_item_time`;
    const AI_RECOMMENDATIONS_URL = `/planner/${PLAN_ID}/ai_recommendations`;
    const ADD_RECOMMENDATION_URL = `/planner/${PLAN_ID}/add_recommendation`;
    const GET_ITINERARY_DATA_URL = `/planner/${PLAN_ID}/get_itinerary_data`;

    // Initialize map
    document.addEventListener('DOMContentLoaded', function() {
        // Apply animation delays from data attributes
        document.querySelectorAll('.animate.fade-in[data-delay]').forEach(element => {
            const delay = element.getAttribute('data-delay');
            element.style.animationDelay = delay + 's';
        });

        // 应用进度条宽度
        document.querySelectorAll('.progress-bar[data-width]').forEach(element => {
            const width = element.getAttribute('data-width');
            element.style.width = width + '%';
            element.setAttribute('aria-valuenow', width);
        });

        // Initialize tooltips
        const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]');
        const tooltipList = [...tooltipTriggerList].map(tooltipTriggerEl => new bootstrap.Tooltip(tooltipTriggerEl));

        // 确保地图初始化
        initializePlanMap();
        
        // Setup modals - 将modal实例定义在更高的作用域内
        const timeEditorModal = new bootstrap.Modal(document.getElementById('timeEditorModal'));
        const deleteConfirmModal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));
        const dayTimeEditorModal = new bootstrap.Modal(document.getElementById('dayTimeEditorModal'));
        
        // Time edit button click handler
        document.querySelectorAll('.edit-time-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const itemId = this.dataset.itemId;
                const itemElement = document.getElementById(`item-${itemId}`);
                let currentTime = '';
                
                if (itemElement) {
                    const timeElement = itemElement.querySelector('.mb-2 i.fa-clock')?.parentNode;
                    if (timeElement && !timeElement.classList.contains('d-none')) {
                        // Extract time from display
                        const timeText = timeElement.textContent.trim();
                        const timeMatch = timeText.match(/(\d{1,2}):(\d{2})\s*(AM|PM)?/i);
                        
                        if (timeMatch) {
                            let hours = parseInt(timeMatch[1]);
                            const minutes = timeMatch[2];
                            const period = timeMatch[3];
                            
                            // Convert to 24-hour format for time input
                            if (period && period.toUpperCase() === 'PM' && hours < 12) {
                                hours += 12;
                            } else if (period && period.toUpperCase() === 'AM' && hours === 12) {
                                hours = 0;
                            }
                            
                            currentTime = `${hours.toString().padStart(2, '0')}:${minutes}`;
                        }
                    }
                }
                
                document.getElementById('editItemId').value = itemId;
                document.getElementById('visitTime').value = currentTime;
                timeEditorModal.show();
            });
        });
        
        // Save time button click handler
        document.getElementById('saveTimeBtn').addEventListener('click', function() {
            const itemId = document.getElementById('editItemId').value;
            const visitTime = document.getElementById('visitTime').value;
            
            // Update time via AJAX
            fetch(UPDATE_ITEM_TIME_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    item_id: itemId,
                    time: visitTime
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Close modal - use modal close button directly
                    document.getElementById('timeEditorModal').querySelector('.btn-close').click();
                    
                    try {
                        showToast('Time updated successfully', 'success');
                        
                        // display success message
                        const itemElement = document.getElementById(`item-${itemId}`);
                        if (itemElement) {
                            // search for the itinerary-content div
                            const contentDiv = itemElement.querySelector('.itinerary-content');
                            if (!contentDiv) {
                                console.error('Cannot find itinerary-content div inside itinerary item:', itemId);
                                return;
                            }
                            
                            // search for the time element
                            let timeElement = null;
                            const timeElements = contentDiv.querySelectorAll('.mb-2');
                            
                            // iterate through time elements to find the one with clock icon
                            for (let i = 0; i < timeElements.length; i++) {
                                if (timeElements[i].querySelector('i.fa-clock')) {
                                    timeElement = timeElements[i];
                                    break;
                                }
                            }
                            
                            const formattedTime = data.formatted_time || visitTime;
                            
                            // if time element not found, create a new one
                            if (!timeElement) {
                                // create a new time element
                                timeElement = document.createElement('div');
                                timeElement.className = 'mb-2';
                                timeElement.innerHTML = `<i class="far fa-clock text-primary me-1"></i>${formattedTime}`;
                                
                                // Find the right position to insert the time element (after location and cost if they exist)
                                const costElement = contentDiv.querySelector('.fa-money-bill-wave')?.closest('.mb-2');
                                const locationElement = contentDiv.querySelector('.fa-map-marker-alt')?.closest('.mb-2');
                                
                                if (costElement) {
                                    // Insert after cost element
                                    costElement.insertAdjacentElement('afterend', timeElement);
                                } else if (locationElement) {
                                    // Insert after location element
                                    locationElement.insertAdjacentElement('afterend', timeElement);
                                } else {
                                    // Insert after title (h5)
                                    const titleElement = contentDiv.querySelector('h5');
                                    if (titleElement) {
                                        titleElement.insertAdjacentElement('afterend', timeElement);
                                    } else {
                                        // Fallback: just append to content div
                                        contentDiv.appendChild(timeElement);
                                    }
                                }
                            } else {
                                // if time element found, update its content
                                timeElement.innerHTML = `<i class="far fa-clock text-primary me-1"></i>${formattedTime}`;
                            }
                        } else {
                            console.error('Cannot find itinerary item:', itemId);
                        }
                    } catch (error) {
                        console.error('Error updating time:', error);
                        showToast('Time updated successfully but unable to refresh display', 'warning');
                    }
                } else {
                    showToast(data.message || 'Time update unsuccessful', 'danger');
                }
            })
            .catch(error => {
                console.error('Error updating time:', error);
                showToast('Error updating time', 'danger');
            });
        });
        
        // Delete button click handler
        document.querySelectorAll('.delete-item-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const itemId = this.dataset.itemId;
                document.getElementById('deleteItemId').value = itemId;
                deleteConfirmModal.show();
            });
        });
        
        // Confirm delete button click handler
        document.getElementById('confirmDeleteBtn').addEventListener('click', function() {
            const itemId = document.getElementById('deleteItemId').value;

            // Delete item via AJAX
            fetch(DELETE_ITINERARY_ITEM_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    item_id: itemId
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Close modal
                    document.getElementById('deleteConfirmModal').querySelector('.btn-close').click();

                    console.log("Delete successful. Received data:", data); // Log received data

                    // Remove the item from the UI with animation
                    const itemElement = document.getElementById(`item-${itemId}`);
                    if (itemElement) {
                        // ... UI removal animation logic ...
                        itemElement.style.transition = 'all 0.3s ease';
                        itemElement.style.opacity = '0';
                        itemElement.style.maxHeight = '0';
                        itemElement.style.overflow = 'hidden';

                        setTimeout(() => {
                            itemElement.remove();
                            // Check if the day section is now empty
                            const daySection = itemElement.closest('.day-container'); // Use day-container
                            if (daySection && daySection.querySelectorAll('.itinerary-item').length === 0) {
                                // Remove the day header and the container
                                const dayHeader = daySection.querySelector('.itinerary-day');
                                if(dayHeader) dayHeader.remove();
                                daySection.remove();
                            }
                        }, 300); // Delay removal for animation
                    }


                    // update cost
                    if (data.total_cost !== undefined) {
                        console.log("Updating total cost display."); // Log cost update
                        // ... update total cost display logic ...
                        const totalCostElements = document.querySelectorAll('.fs-4, .small.text-muted.mb-4 span:first-child');
                        totalCostElements.forEach(el => {
                            if (el.classList.contains('fs-4')) {
                                el.textContent = '$' + data.total_cost;
                            } else {
                                el.textContent = 'Spent: $' + data.total_cost;
                            }
                        });

                        // ... update progress bar logic ...
                        if (PLAN_BUDGET > 0) {
                            const progressBar = document.querySelector('.progress-bar');
                            if (progressBar) {
                                const percentage = (data.total_cost / PLAN_BUDGET) * 100;
                                progressBar.style.width = percentage + '%';
                                progressBar.setAttribute('aria-valuenow', percentage);
                            }
                        }
                    }

                    // if map is initialized, update markers
                    if (window.planMap && data.itinerary_items_json) {
                        console.log("Map instance found. Calling updateMapMarkers with:", data.itinerary_items_json); // Log before calling updateMapMarkers
                        try {
                            updateMapMarkers(data.itinerary_items_json);
                            console.log("updateMapMarkers called successfully after delete."); // Log after calling
                        } catch (mapError) {
                            console.error('Error updating map after delete:', mapError); // Log specific error
                        } 
                    } else {
                        // Log why updateMapMarkers wasn't called
                        if (!window.planMap) {
                            console.log("Map update skipped: window.planMap is not defined.");
                        }
                        if (!data.itinerary_items_json) {
                            console.log("Map update skipped: data.itinerary_items_json is missing or empty in response.");
                        }
                    }

                    showToast('Activity removed successfully', 'success');

                } else {
                    showToast(data.message || 'Error removing activity', 'danger');
                }
            })
            .catch(error => {
                console.error('Error deleting item:', error);
                showToast('An error occurred while removing the activity', 'danger');
            });
        });
        
        // Toast function for feedback
        function showToast(message, type = 'info') {
            const toastContainer = document.getElementById('toastContainer') || createToastContainer();
            const toastId = 'toast-' + Date.now();
            
            const toast = document.createElement('div');
            toast.className = `toast align-items-center text-white bg-${type} border-0`;
            toast.setAttribute('id', toastId);
            toast.setAttribute('role', 'alert');
            toast.setAttribute('aria-live', 'assertive');
            toast.setAttribute('aria-atomic', 'true');
            
            toast.innerHTML = `
                <div class="d-flex">
                    <div class="toast-body">
                        ${message}
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
            `;
            
            toastContainer.appendChild(toast);
            const toastInstance = new bootstrap.Toast(toast);
            toastInstance.show();
            
            // Auto-remove toast from DOM after it's hidden
            toast.addEventListener('hidden.bs.toast', function() {
                this.remove();
            });
        }
        
        function createToastContainer() {
            const container = document.createElement('div');
            container.className = 'toast-container position-fixed bottom-0 end-0 p-3';
            container.setAttribute('id', 'toastContainer');
            document.body.appendChild(container);
            return container;
        }

        // AI Recommendations
        const getRecommendationsBtn = document.getElementById('getRecommendations');
        const daySelect = document.getElementById('recommendationDay');
        const recommendationsContainer = document.getElementById('aiRecommendations');
        const loadingSpinner = document.getElementById('aiLoadingSpinner');
        const errorMessage = document.getElementById('aiErrorMessage');
        
        if (getRecommendationsBtn) {
            getRecommendationsBtn.addEventListener('click', function() {
                // display loading spinner and hide previous results
                recommendationsContainer.innerHTML = '';
                loadingSpinner.classList.remove('d-none');
                errorMessage.classList.add('d-none');
                
                // get selected day
                const selectedDay = parseInt(daySelect.value) || 1;
                
                // send request to server
                fetch(AI_RECOMMENDATIONS_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        day: selectedDay
                    })
                })
                .then(response => response.json())
                .then(data => {
                    // hide loading spinner
                    loadingSpinner.classList.add('d-none');
                    
                    if (data.success) {
                        // clear previous recommendations
                        renderRecommendations(data.recommendations, data.day);
                    } else {
                        // display error message
                        errorMessage.textContent = data.message || 'Error getting recommendations';
                        errorMessage.classList.remove('d-none');
                    }
                })
                .catch(error => {
                    console.error('Error fetching recommendations:', error);
                    loadingSpinner.classList.add('d-none');
                    errorMessage.textContent = 'Error getting recommendations. Please try again later.';
                    errorMessage.classList.remove('d-none');
                });
            });
        }
        
        // validate and render recommendations
        function renderRecommendations(recommendations, day) {
            if (!recommendations || recommendations.length === 0) {
                recommendationsContainer.innerHTML = '<div class="alert alert-info">No recommendations found. Please adjust your travel preferences or try a different day.</div>';
                return;
            }
            
            recommendationsContainer.innerHTML = '<h5 class="mb-3">Recommended Activities</h5>';
            
            recommendations.forEach((rec, index) => {
                // clear and validate data
                const cleanRec = {
                    activity: rec.activity || '',
                    location: rec.location || '',
                    cost: typeof rec.cost === 'number' ? rec.cost : parseFloat(rec.cost || 0),
                    description: rec.description || '',
                    time_spent: rec.time_spent || ''
                };
                
                const timeCost = [];
                if (cleanRec.time_spent) timeCost.push(`<i class="far fa-clock text-muted me-1"></i>${cleanRec.time_spent}`);
                if (cleanRec.cost) timeCost.push(`<i class="fas fa-tag text-success me-1"></i>$${cleanRec.cost}`);
                
                const recCard = document.createElement('div');
                recCard.className = 'ai-recommendation recommendation-item mb-3 animate fade-in';
                
                recCard.innerHTML = `
                    <h5>${cleanRec.activity}</h5>
                    <p class="mb-1"><i class="fas fa-map-marker-alt text-danger me-1"></i>${cleanRec.location || 'No specified location'}</p>
                    <p class="small text-muted mb-2">${timeCost.join(' · ')}</p>
                    <p class="mb-0">${cleanRec.description || ''}</p>
                    <button class="btn btn-sm btn-outline-primary btn-add-recommendation" 
                            data-day="${day}" 
                            data-index="${index}">
                        <i class="fas fa-plus"></i> Add
                    </button>
                `;
                
                recommendationsContainer.appendChild(recCard);
            });
            
            // save recommendations data in a hidden div for later use
            if (!document.getElementById('recommendationsData')) {
                const dataHolder = document.createElement('div');
                dataHolder.id = 'recommendationsData';
                dataHolder.style.display = 'none';
                document.body.appendChild(dataHolder);
            }
            document.getElementById('recommendationsData').setAttribute('data-recommendations', JSON.stringify(recommendations));
            
            // add event listeners to buttons
            document.querySelectorAll('.btn-add-recommendation').forEach(btn => {
                btn.addEventListener('click', function(event) {
                    const day = this.dataset.day;
                    const index = parseInt(this.dataset.index);
                    
                    // get the recommendation data from the hidden div
                    const allRecommendations = JSON.parse(document.getElementById('recommendationsData').getAttribute('data-recommendations'));
                    const rec = allRecommendations[index];
                    
                    addRecommendationToItinerary(day, rec, event.target);
                });
            });
        }
        
        // add recommendation to itinerary
        function addRecommendationToItinerary(day, recommendation, buttonElement) {
            // disable the button and show loading spinner
            if (buttonElement) {
                buttonElement.disabled = true;
                buttonElement.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Adding...';
            }
            
            // clean data
            const cleanData = {
                day: parseInt(day),
                activity: recommendation.activity || '',
                location: recommendation.location || '',
                cost: typeof recommendation.cost === 'number' ? recommendation.cost : parseFloat(recommendation.cost || 0),
                description: recommendation.description || ''
            };
            
            // Add coordinate data if exists
            if (recommendation.lat !== undefined) cleanData.lat = recommendation.lat;
            if (recommendation.lng !== undefined) cleanData.lng = recommendation.lng;
            
            // handle missing or invalid data
            if (isNaN(cleanData.cost)) cleanData.cost = 0;
            
            console.log('Sending data to server:', cleanData);
            
            fetch(ADD_RECOMMENDATION_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(cleanData)
            })
            .then(response => {
                // check response status
                if (!response.ok) {
                    return response.json().then(errorData => {
                        throw new Error(errorData.message || `HTTP error! Status: ${response.status}`);
                    }).catch(jsonError => {
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    });
                }
                return response.json();
            })
            .then(data => {
                // Show success message
                showToast('Activity has been added to your itinerary!', 'success');
                
                // Update the button state to show "Added"
                if (buttonElement) {
                    buttonElement.textContent = 'Added';
                    buttonElement.classList.remove('btn-outline-primary');
                    buttonElement.classList.add('btn-success');
                    buttonElement.disabled = true;
                }
                
                if (data.success) {
                    console.log('Activity added successfully, now updating UI...');
                    
                    // Update itinerary section dynamically with new data
                    if (data.itinerary_items_json) {
                        try {
                            // First, update map markers if map exists
                            if (window.planMap) {
                                console.log('Updating map markers with new data');
                                updateMapMarkers(data.itinerary_items_json);
                            }
                            
                            // Then get the full itinerary data
                            updateItinerary(true);
                        } catch (error) {
                            console.error('Error updating UI after adding activity:', error);
                        }
                    } else {
                        // Fallback to standard update if no items data received
                        updateItinerary();
                    }
                } else {
                    // Reset button state on failure
                    if (buttonElement) {
                        buttonElement.disabled = false;
                        buttonElement.innerHTML = '<i class="fas fa-plus"></i> Add';
                    }
                    showToast(data.message || 'Failed to add activity', 'danger');
                }
            })
            .catch(error => {
                console.error('Error adding recommendation:', error);
                
                // Show error message
                showToast(`Error adding activity: ${error.message || 'Server error'}`, 'danger');
                
                // Reset button state
                if (buttonElement) {
                    buttonElement.disabled = false;
                    buttonElement.innerHTML = '<i class="fas fa-plus"></i> Add';
                }
            });
        }
        
        // Function to update itinerary section without refreshing page
        function updateItinerary(isHighlightNewest = false) {
            console.log('Starting to update itinerary...');
            // Show a small loading indicator
            const itineraryContainer = document.getElementById('itinerary-container');
            let loadingIndicator = null;
            
            if (itineraryContainer) {
                loadingIndicator = document.createElement('div');
                loadingIndicator.className = 'text-center p-2';
                loadingIndicator.id = 'itinerary-loading';
                loadingIndicator.innerHTML = '<div class="spinner-border spinner-border-sm text-primary" role="status"><span class="visually-hidden">Loading...</span></div> <span class="small">Updating itinerary...</span>';
                itineraryContainer.appendChild(loadingIndicator);
            }
            
            fetch(GET_ITINERARY_DATA_URL)
            .then(response => {
                console.log('Get response:', response.status);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('Received itinerary data:', data);
                
                // Remove loading indicator if it exists
                if (loadingIndicator) {
                    loadingIndicator.remove();
                }
                
                if (!data.success) {
                    console.warn('Server returned unsuccessful status:', data.message);
                    return;
                }
                
                // update total cost and budget
                if (data.total_cost !== undefined) {
                    const totalCostElements = document.querySelectorAll('.fs-4, .small.text-muted.mb-4 span:first-child');
                    totalCostElements.forEach(el => {
                        if (el.classList.contains('fs-4')) {
                            el.textContent = '$' + data.total_cost;
                        } else {
                            el.textContent = 'Spent: $' + data.total_cost;
                        }
                    });
                    
                    // update progress bar
                    const progressBar = document.querySelector('.progress-bar');
                    if (progressBar && data.budget) {
                        const percentage = (data.total_cost / data.budget) * 100;
                        progressBar.style.width = percentage + '%';
                        progressBar.setAttribute('aria-valuenow', percentage);
                    }
                }
                
                // update categories
                if (data.categories) {
                    // check if categories section exists
                    const categoriesTitle = document.querySelector('.card-body h5');
                    let categoriesContainer = null;
                    
                    if (categoriesTitle && categoriesTitle.textContent === 'Expenses by Category') {
                        //if it exists, find the next sibling
                        categoriesContainer = categoriesTitle.nextElementSibling;
                    } else {
                        // if not, create a new section
                        const budgetCard = document.querySelector('.card-body .progress').closest('.card-body');
                        if (budgetCard) {
                            let categoriesSection = document.createElement('div');
                            categoriesSection.innerHTML = '<h5>Expenses by Category</h5><div class="mb-4"></div>';
                            budgetCard.appendChild(categoriesSection);
                            categoriesContainer = categoriesSection.querySelector('.mb-4');
                        }
                    }
                    
                    // if categoriesContainer exists, update its content
                    if (categoriesContainer) {
                        let categoriesHTML = '';
                        
                        Object.entries(data.categories).forEach(([category, amount]) => {
                            const percentage = (amount / data.total_cost) * 100 || 0;
                            categoriesHTML += `
                                <div class="mb-2">
                                    <div class="d-flex justify-content-between mb-1">
                                        <span>${category}</span>
                                        <span>$${amount}</span>
                                    </div>
                                    <div class="progress" style="height: 5px; border-radius: 5px;">
                                        <div class="progress-bar" role="progressbar" 
                                            style="width: ${percentage}%;" 
                                            aria-valuenow="${percentage}" 
                                            aria-valuemin="0" 
                                            aria-valuemax="100">
                                        </div>
                                    </div>
                                </div>
                            `;
                        });
                        
                        categoriesContainer.innerHTML = categoriesHTML;
                    }
                }
                
                // update itinerary content
                if (data.itinerary_by_day) {
                    console.log('Updating itinerary section with new data');
                    
                    // Check if we're updating an existing itinerary section or need to create a new one
                    let itineraryRow = document.querySelector('.row:has(#itinerary-container)');
                    
                    if (!itineraryRow) {
                        // We need to create the entire itinerary section
                        console.log('Creating new itinerary section');
                        const mainContainer = document.querySelector('.container.py-5');
                        
                        if (!mainContainer) {
                            console.error('Cannot find main container');
                            return;
                        }
                        
                        // Create the header row
                        const headerRow = document.createElement('div');
                        headerRow.className = 'row mb-4';
                        headerRow.innerHTML = `
                            <div class="col-12">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h2>Itinerary</h2>
                                    <a href="/planner/${PLAN_ID}/itinerary" class="btn btn-primary">
                                        <i class="fas fa-plus me-1"></i> Add Activity
                                    </a>
                                </div>
                            </div>
                        `;
                        
                        mainContainer.appendChild(headerRow);
                        
                        // Create the content row
                        itineraryRow = document.createElement('div');
                        itineraryRow.className = 'row';
                        mainContainer.appendChild(itineraryRow);
                    }
                    
                    // Check if we're updating an empty or existing itinerary
                    if (data.itinerary_by_day.length === 0) {
                        // Empty itinerary - show the empty state
                        itineraryRow.innerHTML = `
                            <div class="col-12">
                                <div class="card animate fade-in" data-delay="0.3">
                                    <div class="card-body text-center py-5">
                                        <i class="fas fa-calendar-day fa-3x text-muted mb-3"></i>
                                        <h3>No itinerary items yet</h3>
                                        <p>Start planning your daily activities for this trip.</p>
                                        <a href="/planner/${PLAN_ID}/itinerary" class="btn btn-primary mt-3">
                                            Add Activities
                                        </a>
                                    </div>
                                </div>
                            </div>
                        `;
                    } else {
                        // We have itinerary items - create or update the card
                        let itineraryCard = itineraryRow.querySelector('.card');
                        
                        if (!itineraryCard) {
                            // Create the card structure
                            itineraryRow.innerHTML = `
                                <div class="col-12">
                                    <div class="card animate fade-in" data-delay="0.3">
                                        <div class="card-body p-4" id="itinerary-container">
                                            <!-- Itinerary items will be inserted here -->
                                        </div>
                                    </div>
                                </div>
                            `;
                        }
                        
                        // Now get the itinerary container and update its content
                        const itineraryContainer = document.getElementById('itinerary-container') || 
                                                  itineraryRow.querySelector('.card-body');
                        
                        if (!itineraryContainer) {
                            console.error('Cannot find or create itinerary container');
                            return;
                        }
                        
                        let itineraryHTML = '';
                        
                        // Generate HTML for each day and its items
                        data.itinerary_by_day.forEach(([day, items]) => {
                            let dayHTML = `
                            <div class="mb-4 day-container day-${day}">
                                <div class="bg-light rounded p-3 mb-3 itinerary-day">
                                    <h4 class="mb-0">Day ${day}: ${data.day_dates ? data.day_dates[day-1] : ''}</h4>
                                </div>
                            `;
                            
                            items.forEach(item => {
                                // Check if this is a new item (for highlighting)
                                const isNew = isHighlightNewest && item.id === data.item?.id;
                                const highlightClass = isNew ? 'highlight-new' : '';
                                
                                dayHTML += `
                                <div class="itinerary-item animate fade-in ${highlightClass}" id="item-${item.id}">
                                    <div class="d-flex flex-column flex-md-row justify-content-between">
                                        <div class="itinerary-content">
                                            <h5>${item.activity || ''}</h5>
                                            ${item.location ? `
                                            <div class="mb-2">
                                                <i class="fas fa-map-marker-alt text-danger me-2"></i>
                                                ${item.location}
                                            </div>
                                            ` : ''}
                                            ${item.cost ? `
                                            <div class="mb-2">
                                                <i class="fas fa-money-bill-wave text-success me-2"></i>
                                                $${item.cost}
                                            </div>
                                            ` : ''}
                                            ${item.time ? `
                                            <div class="mb-2">
                                                <i class="far fa-clock text-primary me-1"></i>
                                                ${item.time}
                                            </div>
                                            ` : ''}
                                            ${item.notes ? `
                                            <p class="text-muted">${item.notes}</p>
                                            ` : ''}
                                        </div>
                                        <div class="itinerary-actions">
                                            <button type="button" class="btn btn-sm btn-outline-primary edit-time-btn" 
                                                    data-item-id="${item.id}" data-bs-toggle="tooltip" 
                                                    title="Set/edit time">
                                                <i class="fas fa-clock"></i>
                                            </button>
                                            <button type="button" class="btn btn-sm btn-outline-danger mt-2 delete-item-btn"
                                                    data-item-id="${item.id}" data-bs-toggle="tooltip"
                                                    title="Remove activity">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                `;
                            });
                            
                            dayHTML += `</div>`;
                            itineraryHTML += dayHTML;
                        });
                        
                        // Update the DOM
                        itineraryContainer.innerHTML = itineraryHTML;
                        
                        // Add event listeners to the new buttons
                        addEventListenersToButtons();
                        
                        // Initialize tooltips for the new buttons
                        const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]');
                        [...tooltipTriggerList].map(tooltipTriggerEl => new bootstrap.Tooltip(tooltipTriggerEl));
                        
                        // If highlighting new item, add a scroll effect
                        if (isHighlightNewest && data.item) {
                            setTimeout(() => {
                                const newItem = document.getElementById(`item-${data.item.id}`);
                                if (newItem) {
                                    newItem.scrollIntoView({behavior: 'smooth', block: 'center'});
                                    
                                    // Add brief highlight animation
                                    newItem.style.transition = 'background-color 1s';
                                    newItem.style.backgroundColor = 'rgba(var(--bs-success-rgb), 0.1)';
                                    setTimeout(() => {
                                        newItem.style.backgroundColor = '';
                                    }, 2000);
                                }
                            }, 300);
                        }
                    }
                }
            })
            .catch(error => {
                console.error('Error updating itinerary data:', error);
                
                // Remove loading indicator if it exists
                if (loadingIndicator) {
                    loadingIndicator.remove();
                }
                
                // Show error message
                showToast('There was an issue updating the itinerary. The data may be out of date.', 'warning');
            });
        }
        
        // Add event listeners to newly generated buttons
        function addEventListenersToButtons() {
            // Add event listeners for time edit buttons
            document.querySelectorAll('.edit-time-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const itemId = this.dataset.itemId;
                    document.getElementById('editItemId').value = itemId;
                    
                    // Try to get current time value
                    const timeElement = document.querySelector(`#item-${itemId} .fa-clock`);
                    let currentTime = '';
                    if (timeElement) {
                        const timeText = timeElement.parentNode.textContent.trim();
                        const timeMatch = timeText.match(/(\d{1,2}):(\d{2})\s*(AM|PM)?/i);
                        if (timeMatch) {
                            let hours = parseInt(timeMatch[1]);
                            const minutes = timeMatch[2];
                            const period = timeMatch[3];
                            
                            if (period && period.toUpperCase() === 'PM' && hours < 12) {
                                hours += 12;
                            } else if (period && period.toUpperCase() === 'AM' && hours === 12) {
                                hours = 0;
                            }
                            
                            currentTime = `${hours.toString().padStart(2, '0')}:${minutes}`;
                        }
                    }
                    
                    document.getElementById('visitTime').value = currentTime;
                    const timeEditorModal = new bootstrap.Modal(document.getElementById('timeEditorModal'));
                    timeEditorModal.show();
                });
            });
            
            // Add event listeners for delete buttons
            document.querySelectorAll('.delete-item-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const itemId = this.dataset.itemId;
                    document.getElementById('deleteItemId').value = itemId;
                    const deleteConfirmModal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));
                    deleteConfirmModal.show();
                });
            });
        }
    });

    // Add AI recommendation to itinerary
    function addRecommendation(activityId) {
        const loadingBtn = document.querySelector(`button[data-activity-id="${activityId}"].loading`);
        const normalBtn = document.querySelector(`button[data-activity-id="${activityId}"]:not(.loading)`);
        
        if (loadingBtn) loadingBtn.style.display = 'inline-block';
        if (normalBtn) normalBtn.style.display = 'none';
        
        fetch(ADD_RECOMMENDATION_URL, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token() }}'
            },
            body: JSON.stringify({
                activity_id: activityId
            })
        })
        .then(response => response.json())
        .then(data => {
            if (loadingBtn) loadingBtn.style.display = 'none';
            if (normalBtn) normalBtn.style.display = 'inline-block';
            
            if (data.success) {
                showToast('Activity added to your itinerary!', 'success');
                
                // Change button status to added
                const addBtn = document.querySelector(`button[data-activity-id="${activityId}"]:not(.loading)`);
                if (addBtn) {
                    addBtn.disabled = true;
                    addBtn.innerHTML = '<i class="fas fa-check"></i> Added';
                    addBtn.classList.remove('btn-primary');
                    addBtn.classList.add('btn-success');
                }
                
                // Real-time update itinerary section
                updateItinerary();
                
                // Apply animation effect to highlight newly added item
                setTimeout(() => {
                    const newItem = document.getElementById(`item-${data.item_id}`);
                    if (newItem) {
                        newItem.classList.add('highlight-new');
                        setTimeout(() => {
                            newItem.classList.remove('highlight-new');
                        }, 3000);
                    }
                }, 500);
            } else {
                showToast(data.error || 'Failed to add activity', 'danger');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            if (loadingBtn) loadingBtn.style.display = 'none';
            if (normalBtn) normalBtn.style.display = 'inline-block';
            showToast('An error occurred. Please try again.', 'danger');
        });
    }

    // Initialize map
    function initializePlanMap() {
        // Initialize map
        const mapElement = document.getElementById('planMap');
        if (!mapElement) {
            console.error('Map container #planMap not found!'); // Log if container missing
            return;
        }
        
        // Get itinerary item data from data attribute
        let itineraryItems;
        try {
            const itemsData = mapElement.dataset.items || '[]';
            console.log('Raw data-items attribute:', itemsData); // Log raw data
            itineraryItems = JSON.parse(itemsData);
            console.log('Parsed initial itinerary items for map:', itineraryItems); // Log parsed data
        } catch (e) {
            console.error('Error parsing itinerary item data:', e);
            itineraryItems = [];
        }
        
        // Initialize map
        const map = L.map('planMap');
        
        // Add OpenStreetMap tile layer
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);
        
        // Save map instance to global variable for later updates
        window.planMap = map;
        
        // Initialize map markers
        updateMapMarkers(itineraryItems);
    }
    
    // Update map markers
    function updateMapMarkers(items) {
        console.log('Updating map markers with items:', items); // Log items received
        const map = window.planMap;
        if (!map) {
            console.error('Map instance not found');
            return;
        }
        
        // Clear existing markers
        map.eachLayer(layer => {
            if (layer instanceof L.Marker) {
                map.removeLayer(layer);
            }
        });
        
        // Filter valid coordinates
        const validItems = items.filter(item => {
            return item && typeof item === 'object' && 
                   item.lat !== undefined && item.lng !== undefined &&
                   !isNaN(parseFloat(item.lat)) && !isNaN(parseFloat(item.lng));
        });
        
        if (validItems.length === 0) {
            // If no valid coordinates, show default location (e.g. destination center)
            map.setView([0, 0], 2);
            return;
        }
        
        // Prepare map bounds
        const bounds = L.latLngBounds();
        
        // Add markers and routes
        validItems.forEach((item, index) => {
            try {
                // Parse coordinates
                const lat = parseFloat(item.lat);
                const lng = parseFloat(item.lng);
                
                if (isNaN(lat) || isNaN(lng)) {
                    console.warn(`Coordinates for item ${index} are invalid: ${item.lat}, ${item.lng}`);
                    return;
                }
                
                // Extend bounds
                bounds.extend([lat, lng]);
                
                // Create marker
                const marker = L.marker([lat, lng]).addTo(map);
                
                // --- Add permanent tooltip ---
                let tooltipContent = '';
                if (item.day) {
                    tooltipContent += `Day ${item.day}`;
                }
                if (item.time) {
                    // Add a separator if both day and time exist
                    if (tooltipContent) tooltipContent += `<br>`; 
                    tooltipContent += `${item.time}`;
                }

                if (tooltipContent) {
                    marker.bindTooltip(tooltipContent, {
                        permanent: true, // Keep tooltip always visible
                        direction: 'top', // Show above the marker
                        offset: [0, -15], // Adjust position slightly
                        className: 'map-tooltip' // Add a class for potential styling
                    });
                }
                // --- End of tooltip addition ---

                // Add popup information
                let popupContent = `<h5>${item.activity || 'Unnamed Activity'}</h5>`;
                if (item.location) popupContent += `<p>${item.location}</p>`;
                if (item.day) popupContent += `<p>Day ${item.day}</p>`;
                if (item.time) popupContent += `<p>Time: ${item.time}</p>`;
                
                marker.bindPopup(popupContent);
            } catch (e) {
                console.error(`Error adding marker for item ${index}:`, e);
            }
        });
        
        // Adjust map view to include all markers
        if (bounds.isValid()) {
            map.fitBounds(bounds, {
                padding: [50, 50],
                maxZoom: 15
            });
        }
    }
</script>
{% endblock %}

{% endblock %}
