{% extends 'base.html' %}

{% block title %}Memory Map{% endblock %}

{% block head %}
{{ super() }}
<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
{% endblock %}

{% block styles %}
{{ super() }}
<style>
    .map-container {
        position: relative;
        padding: 1rem;
        background-color: #fff;
        border-radius: 10px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        margin-bottom: 2rem;
    }
    
    #memory-map {
        height: 600px;
        width: 100%;
        border-radius: 8px;
        overflow: hidden;
        transition: all 0.3s ease;
    }
    
    .map-controls {
        position: absolute;
        top: 20px;
        right: 30px;
        z-index: 999;
        display: flex;
        gap: 10px;
    }
    
    .map-control-btn {
        padding: 8px 12px;
        background-color: white;
        border-radius: 4px;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
        cursor: pointer;
        transition: all 0.2s ease;
        border: none;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .map-control-btn:hover {
        background-color: #f8f9fa;
        transform: translateY(-2px);
    }
    
    .memory-info-window {
        max-width: 320px;
        padding: 5px;
    }
    
    .memory-info-window h4 {
        margin-top: 0;
        margin-bottom: 10px;
        color: #2c3e50;
        font-weight: 600;
    }
    
    .memory-info-window p {
        margin-bottom: 8px;
        color: #444;
    }
    
    .memory-details-link {
        display: inline-block;
        margin-top: 10px;
        transition: all 0.3s ease;
    }
    
    .memory-thumbnail {
        width: 100%;
        height: 120px;
        object-fit: cover;
        border-radius: 4px;
        margin-bottom: 10px;
    }
    
    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
        border-bottom: 2px solid #e9ecef;
        padding-bottom: 1rem;
    }
    
    .loader-container {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(255, 255, 255, 0.8);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
        border-radius: 8px;
    }
    
    .loader {
        border: 5px solid #f3f3f3;
        border-radius: 50%;
        border-top: 5px solid #3498db;
        width: 50px;
        height: 50px;
        animation: spin 1s linear infinite;
    }
    
    .memory-counter {
        background-color: #f8f9fa;
        padding: 8px 15px;
        border-radius: 20px;
        font-weight: 500;
        color: #495057;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        margin-bottom: 15px;
        display: inline-block;
    }
    
    .map-legend {
        position: absolute;
        bottom: 20px;
        left: 20px;
        z-index: 999;
        background-color: white;
        padding: 10px;
        border-radius: 5px;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
    }
    
    .filter-bar {
        background-color: #fff;
        padding: 15px;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
    }
    
    .filter-title {
        font-weight: 600;
        color: #495057;
        margin-right: 10px;
    }
    
    .tag-pill {
        display: inline-block;
        padding: 5px 15px;
        margin: 5px;
        border-radius: 20px;
        font-size: 0.9rem;
        font-weight: 500;
        background-color: #e9ecef;
        color: #495057;
        cursor: pointer;
        transition: all 0.2s ease;
    }
    
    .tag-pill:hover {
        background-color: #dee2e6;
        transform: translateY(-1px);
    }
    
    .tag-pill.active {
        background-color: #007bff;
        color: white;
    }
    
    .memory-list-item {
        padding: 10px 15px;
        border-left: 3px solid transparent;
        transition: all 0.2s ease;
        cursor: pointer;
    }
    
    .memory-list-item:hover {
        background-color: #f8f9fa;
        border-left-color: #007bff;
    }
    
    .memory-list-item.highlighted {
        background-color: #e9f5ff;
        border-left-color: #007bff;
    }
    
    .marker-recent {
        color: #007bff;
    }
    
    .marker-default {
        color: #dc3545;
    }
    
    .custom-marker-icon {
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: bold;
        text-align: center;
    }
    
    .no-memories-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        background-color: rgba(255, 255, 255, 0.9);
        z-index: 998;
        border-radius: 8px;
    }
    
    .no-memories-message {
        text-align: center;
        max-width: 80%;
    }
    
    .no-memories-message h3 {
        color: #495057;
        margin-bottom: 1rem;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    @media (max-width: 768px) {
        #memory-map {
            height: 400px;
        }
        
        .map-controls {
            top: 10px;
            right: 10px;
        }
        
        .page-header {
            flex-direction: column;
            align-items: flex-start;
        }
        
        .page-header > div:last-child {
            margin-top: 15px;
            align-self: flex-end;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="page-header">
        <div>
            <h1>Your Memory Map</h1>
            <p class="text-muted">Visualize and explore all your travel memories around the world</p>
        </div>
        <div>
            <a href="{{ url_for('memories.create_memory') }}" class="btn btn-primary">
                <i class="fas fa-plus"></i> Add New Memory
            </a>
        </div>
    </div>
    
    <div class="filter-bar d-flex flex-wrap align-items-center justify-content-between">
        <div>
            <span class="filter-title">Filter by:</span>
            <span class="tag-pill active" data-tag="all">All</span>
            {% set unique_tags = [] %}
            {% for memory in memories %}
                {% for tag in memory.tags %}
                    {% if tag.name not in unique_tags %}
                        {% set _ = unique_tags.append(tag.name) %}
                        <span class="tag-pill" data-tag="{{ tag.name }}">{{ tag.name }}</span>
                    {% endif %}
                {% endfor %}
            {% endfor %}
        </div>
        <div id="memory-counter" class="memory-counter">
            <i class="fas fa-map-marker-alt"></i> <span id="memory-count">0</span> memories on your map
        </div>
    </div>
    
    <div class="map-container">
        <div id="loader" class="loader-container">
            <div class="loader"></div>
        </div>
        
        <div id="no-memories" class="no-memories-overlay" style="display: none;">
            <div class="no-memories-message">
                <h3>No Memories on Your Map Yet</h3>
                <p>Start adding travel memories with locations to see them appear here.</p>
                <a href="{{ url_for('memories.create_memory') }}" class="btn btn-primary mt-3">
                    <i class="fas fa-plus"></i> Create Your First Memory
                </a>
            </div>
        </div>
        
        <div id="memory-map"></div>
        
        <div class="map-controls">
            <button id="zoomWorld" class="map-control-btn" title="View World Map">
                <i class="fas fa-globe-americas"></i>
            </button>
            <button id="toggleTerrain" class="map-control-btn" title="Toggle Terrain View">
                <i class="fas fa-mountain"></i>
            </button>
        </div>
        
        <div class="map-legend">
            <div class="d-flex align-items-center mb-2">
                <i class="fas fa-map-marker-alt me-2 marker-default"></i>
                <span>Regular Memory</span>
            </div>
            <div class="d-flex align-items-center">
                <i class="fas fa-map-marker-alt me-2 marker-recent"></i>
                <span>Recent Memory (last 30 days)</span>
            </div>
        </div>
    </div>
    
    <div class="row mt-4">
        <div class="col-md-12">
            <h3>Memory List</h3>
            <div class="card">
                <div class="card-body p-0">
                    <div class="list-group list-group-flush">
                        {% for memory in memories %}
                            {% if memory.lat is not none and memory.lng is not none %}
                                <div class="memory-list-item" data-id="{{ memory.id }}">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <h5 class="mb-1">{{ memory.title }}</h5>
                                            <p class="mb-1 text-muted">
                                                <i class="fas fa-map-marker-alt"></i> {{ memory.location or 'No location specified' }}
                                                {% if memory.visit_date %}
                                                    &bull; <i class="far fa-calendar-alt"></i> {{ memory.visit_date.strftime('%B %d, %Y') }}
                                                {% endif %}
                                            </p>
                                        </div>
                                        <a href="{{ url_for('memories.view_memory', memory_id=memory.id) }}" class="btn btn-sm btn-outline-primary">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                    </div>
                                </div>
                            {% endif %}
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="d-flex justify-content-start my-4">
        <a href="{{ url_for('memories.index') }}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left"></i> Back to Memories
        </a>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Debug to see if script is loading
        console.log('Memory map standalone script loaded');
        
        // Show loading indicator
        const loader = document.getElementById('loader');
        const noMemoriesOverlay = document.getElementById('no-memories');
        const memoryCountElement = document.getElementById('memory-count');
        
        function showLoader() {
            if (loader) loader.style.display = 'flex';
        }
        
        function hideLoader() {
            if (loader) loader.style.display = 'none';
        }
        
        showLoader();
        
        // Initialize memory data array properly with JSON safe formatting
        const memoryData = JSON.parse('{{ memories_json|safe }}');
        
        console.log('Memory data loaded:', memoryData.length, 'locations');
        
        // Initialize map and variables
        let map;
        let markers = [];
        let markersByTag = {};
        
        // Initialize Leaflet Map
        function initMap() {
            try {
                console.log('Initializing map...');
                
                // Create map
                map = L.map('memory-map', {
                    center: [20, 0],
                    zoom: 2,
                    minZoom: 2,
                    maxZoom: 18
                });
                
                // Add tile layer (OpenStreetMap)
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                    maxZoom: 19
                }).addTo(map);
                
                // Create markers for each memory
                createMemoryMarkers();
                
                // Set up map controls
                setupMapControls();
                
                // Add event listeners to tag pills
                setupTagFiltering();
                
                // Add event listeners to memory list items
                setupMemoryListInteractions();
                
                // Hide loader when map is loaded
                map.whenReady(() => {
                    setTimeout(() => {
                        hideLoader();
                    }, 500);
                });
            } catch (error) {
                console.error('Map initialization error:', error);
                hideLoader();
                document.getElementById('memory-map').innerHTML = 
                    '<div class="alert alert-danger m-3">Error loading map. Please refresh the page and try again.</div>';
            }
        }
        
        // Create markers for all memories
        function createMemoryMarkers() {
            // Check if we have memories with coordinates
            if (memoryData.length === 0) {
                if (noMemoriesOverlay) noMemoriesOverlay.style.display = 'flex';
                if (memoryCountElement) memoryCountElement.textContent = '0';
                return;
            }
            
            // Hide the "no memories" message
            if (noMemoriesOverlay) noMemoriesOverlay.style.display = 'none';
            
            // Bounds to fit all markers
            const bounds = L.latLngBounds();
            
            // Create a marker for each memory
            memoryData.forEach(memory => {
                try {
                    console.log(`Creating marker for ${memory.title} at [${memory.lat}, ${memory.lng}]`);
                    
                    // Create marker icon
                    const icon = L.divIcon({
                        className: 'custom-marker-icon',
                        html: `<div style="background-color: ${memory.isRecent ? '#007bff' : '#dc3545'}; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.3);">
                                <i class="fas fa-map-marker-alt" style="color: white;"></i>
                              </div>`,
                        iconSize: [30, 30],
                        iconAnchor: [15, 30],
                        popupAnchor: [0, -30]
                    });
                    
                    // Create marker
                    const marker = L.marker([memory.lat, memory.lng], {
                        icon: icon,
                        title: memory.title,
                        memoryId: memory.id
                    });
                    
                    // Create popup content
                    let popupContent = `
                        <div class="memory-info-window">
                            <h4>${memory.title}</h4>
                            <p><i class="fas fa-map-marker-alt"></i> <strong>${memory.location}</strong></p>
                            <p><i class="far fa-calendar-alt"></i> ${memory.visit_date || 'Date not specified'}</p>
                    `;
                    
                    if (memory.description) {
                        popupContent += `<p><i class="fas fa-quote-left"></i> ${memory.description.length > 100 ? memory.description.substring(0, 97) + '...' : memory.description}</p>`;
                    }
                    
                    if (memory.image_path) {
                        popupContent += `<img src="${memory.image_path}" alt="${memory.title}" class="memory-thumbnail" onerror="this.onerror=null; this.src='/static/img/plane.jpg'; this.style.opacity=0.7;">`;
                    }
                    
                    popupContent += `
                            <a href="/memories/${memory.id}" class="memory-details-link btn btn-sm btn-primary">
                                <i class="fas fa-eye"></i> View Details
                            </a>
                        </div>
                    `;
                    
                    // Add popup to marker
                    marker.bindPopup(popupContent);
                    
                    // Store memory data with marker for filtering
                    marker.memory = memory;
                    
                    // Add click event to highlight item in list
                    marker.on('click', function() {
                        highlightMemoryInList(memory.id);
                    });
                    
                    // Add marker to map
                    marker.addTo(map);
                    
                    // Add to markers array
                    markers.push(marker);
                    
                    // Extend bounds
                    bounds.extend([memory.lat, memory.lng]);
                    
                    // Organize markers by tags for filtering
                    if (memory.tags && memory.tags.length > 0) {
                        memory.tags.forEach(tag => {
                            if (!markersByTag[tag]) markersByTag[tag] = [];
                            markersByTag[tag].push(marker);
                        });
                    }
                } catch (err) {
                    console.error('Error creating marker:', err, memory);
                }
            });
            
            // Update memory counter
            if (memoryCountElement) memoryCountElement.textContent = markers.length.toString();
            
            // Fit map to show all markers
            if (markers.length > 0) {
                map.fitBounds(bounds, {
                    padding: [50, 50],
                    maxZoom: 12
                });
            }
        }
        
        // Set up map controls
        function setupMapControls() {
            // World view button
            const zoomWorldBtn = document.getElementById('zoomWorld');
            if (zoomWorldBtn) {
                zoomWorldBtn.addEventListener('click', function() {
                    map.setView([20, 0], 2);
                });
            }
            
            // Toggle terrain button
            const toggleTerrainBtn = document.getElementById('toggleTerrain');
            if (toggleTerrainBtn) {
                let terrainMode = false;
                toggleTerrainBtn.addEventListener('click', function() {
                    // Remove current tile layers
                    map.eachLayer(layer => {
                        if (layer instanceof L.TileLayer) {
                            map.removeLayer(layer);
                        }
                    });
                    
                    if (terrainMode) {
                        // Switch to normal map
                        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                            maxZoom: 19
                        }).addTo(map);
                        this.querySelector('i').className = 'fas fa-mountain';
                        this.title = 'Switch to Terrain View';
                    } else {
                        // Switch to terrain map
                        L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
                            attribution: '&copy; <a href="https://opentopomap.org">OpenTopoMap</a> contributors',
                            maxZoom: 17
                        }).addTo(map);
                        this.querySelector('i').className = 'fas fa-map';
                        this.title = 'Switch to Street View';
                    }
                    
                    terrainMode = !terrainMode;
                });
            }
        }
        
        // Set up tag filtering
        function setupTagFiltering() {
            const tagPills = document.querySelectorAll('.tag-pill');
            tagPills.forEach(pill => {
                pill.addEventListener('click', function() {
                    // Update active state
                    tagPills.forEach(p => p.classList.remove('active'));
                    this.classList.add('active');
                    
                    // Get selected tag
                    const tag = this.getAttribute('data-tag');
                    
                    // Filter markers
                    filterMarkersByTag(tag);
                });
            });
        }
        
        // Filter markers by tag
        function filterMarkersByTag(tag) {
            if (tag === 'all') {
                // Show all markers
                markers.forEach(marker => {
                    if (!map.hasLayer(marker)) {
                        marker.addTo(map);
                    }
                });
            } else {
                // First, remove all markers from map
                markers.forEach(marker => {
                    map.removeLayer(marker);
                });
                
                // Then add only markers with the selected tag
                markers.forEach(marker => {
                    if (marker.memory && marker.memory.tags && marker.memory.tags.includes(tag)) {
                        marker.addTo(map);
                    }
                });
            }
            
            // Update visible count
            const visibleMarkers = markers.filter(marker => map.hasLayer(marker));
            if (memoryCountElement) memoryCountElement.textContent = visibleMarkers.length.toString();
            
            // If there are visible markers, adjust map view
            if (visibleMarkers.length > 0) {
                const bounds = L.latLngBounds(visibleMarkers.map(marker => marker.getLatLng()));
                map.fitBounds(bounds, {
                    padding: [50, 50],
                    maxZoom: 12
                });
            }
        }
        
        // Set up interactions with memory list
        function setupMemoryListInteractions() {
            const listItems = document.querySelectorAll('.memory-list-item');
            listItems.forEach(item => {
                item.addEventListener('click', function() {
                    const memoryId = parseInt(this.getAttribute('data-id'));
                    focusOnMemory(memoryId);
                });
            });
        }
        
        // Focus on a specific memory
        function focusOnMemory(memoryId) {
            const marker = markers.find(m => m.options.memoryId === memoryId);
            if (marker) {
                // Center map on marker
                map.setView(marker.getLatLng(), 14);
                
                // Open popup
                marker.openPopup();
                
                // Highlight list item
                highlightMemoryInList(memoryId);
            }
        }
        
        // Highlight memory in list
        function highlightMemoryInList(memoryId) {
            const listItems = document.querySelectorAll('.memory-list-item');
            listItems.forEach(item => {
                item.classList.remove('highlighted');
            });
            
            const selectedItem = document.querySelector(`.memory-list-item[data-id="${memoryId}"]`);
            if (selectedItem) {
                selectedItem.classList.add('highlighted');
                selectedItem.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }
        }
        
        // Initialize the map
        initMap();
    });
</script>
{% endblock %}