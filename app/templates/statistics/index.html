{% extends 'base.html' %}

{% block title %}Travel Statistics - Travel Planning Platform{% endblock %}

{% block extra_css %}
<style>
    .stat-card {
        border-radius: 10px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        transition: all 0.3s ease;
    }
    
    .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
    }
    
    .stat-icon {
        font-size: 2rem;
        height: 60px;
        width: 60px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        margin-bottom: 1rem;
    }
    
    .stat-value {
        font-size: 2rem;
        font-weight: 700;
        margin-bottom: 0.5rem;
    }
    
    .stat-label {
        font-size: 0.9rem;
        color: #6c757d;
        text-transform: uppercase;
        letter-spacing: 1px;
    }
    
    .map-container {
        height: 400px;
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
    }
    
    .recommendation-card {
        border-left: 4px solid #4285f4;
        background-color: #f8f9fa;
        transition: all 0.3s ease;
    }
    
    .recommendation-card:hover {
        background-color: #e9ecef;
    }
    
    /* Address input styles */
    .address-input-container {
        position: relative;
    }
    
    #suggestions-container {
        position: absolute;
        width: 100%;
        max-height: 250px;
        overflow-y: auto;
        z-index: 1000;
        background: white;
        border: 1px solid #dee2e6;
        border-top: none;
        border-radius: 0 0 0.375rem 0.375rem;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    }
    
    .address-suggestion {
        padding: 10px 15px;
        cursor: pointer;
        border-bottom: 1px solid #eee;
    }
    
    .address-suggestion:hover {
        background-color: #f8f9fa;
    }
    
    .address-suggestion:last-child {
        border-bottom: none;
    }
    
    /* Location setting modal */
    .modal-map-container {
        height: 300px;
        border-radius: 4px;
        margin-bottom: 15px;
    }
    
    /* Home marker animation */
    @keyframes pulse {
        0% { transform: scale(0.95); opacity: 0.7; }
        50% { transform: scale(1.05); opacity: 1; }
        100% { transform: scale(0.95); opacity: 0.7; }
    }
    
    .home-icon-container {
        animation: pulse 2s infinite ease-in-out;
        display: flex;
        align-items: center;
        justify-content: center;
        width: 30px;
        height: 30px;
        border-radius: 50%;
        background-color: rgba(255, 255, 255, 0.9);
        box-shadow: 0 0 5px rgba(0, 0, 0, 0.3);
    }
    
    .home-icon {
        color: #dc3545;
        font-size: 16px;
    }
    
    /* Travel animation */
    @keyframes pulse-travel {
        0% { transform: scale(0.8); opacity: 0.7; }
        50% { transform: scale(1.2); opacity: 1; }
        100% { transform: scale(0.8); opacity: 0.7; }
    }
    
    @keyframes glow {
        0% { box-shadow: 0 0 3px rgba(255, 255, 255, 0.7); }
        50% { box-shadow: 0 0 8px rgba(255, 255, 255, 1.0); }
        100% { box-shadow: 0 0 3px rgba(255, 255, 255, 0.7); }
    }
    
    .travel-marker-container {
        position: absolute;
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        filter: drop-shadow(0 0 3px rgba(0, 0, 0, 0.3));
    }
    
    .travel-marker {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background-color: white;
        border: 2px solid;
        animation: pulse-travel 1.5s infinite ease-in-out, glow 1.5s infinite ease-in-out;
    }
    
    .leaflet-control-container .leaflet-top {
        z-index: 999 !important;
    }
</style>
{% endblock %}

{% block content %}
<section class="py-5">
    <div class="container">
        <div class="row mb-4 align-items-center">
            <div class="col-lg-8">
                <h1>Your Travel Statistics</h1>
                <p class="text-muted lead">Insights and summaries from your travel adventures</p>
            </div>
            <div class="col-lg-4 text-lg-end">
                <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#homeLocationModal">
                    <i class="fas fa-home me-2"></i> 
                    {% if home_address %}
                        Update Home Location
                    {% else %}
                        Set Home Location
                    {% endif %}
                </button>
            </div>
        </div>
        
        {% if not home_address %}
            <div class="alert alert-info mb-4" role="alert">
                <i class="fas fa-info-circle me-2"></i> Set your home location to see distance statistics and route visualizations.
            </div>
        {% endif %}
        
        <!-- Key Statistics -->
        <div class="row mb-5">
            <div class="col-md-4 mb-4">
                <div class="card stat-card h-100 p-4">
                    <div class="stat-icon bg-primary-subtle text-primary">
                        <i class="fas fa-map-marked-alt"></i>
                    </div>
                    <div class="stat-value">{{ stats.cities_this_year|length }}</div>
                    <div class="stat-label">Cities Visited This Year</div>
                </div>
            </div>
            <div class="col-md-4 mb-4">
                <div class="card stat-card h-100 p-4">
                    <div class="stat-icon bg-success-subtle text-success">
                        <i class="fas fa-flag"></i>
                    </div>
                    <div class="stat-value">{{ stats.visited_countries|length }}</div>
                    <div class="stat-label">Countries Visited</div>
                </div>
            </div>
            <div class="col-md-4 mb-4">
                <div class="card stat-card h-100 p-4">
                    <div class="stat-icon bg-info-subtle text-info">
                        <i class="fas fa-calendar-check"></i>
                    </div>
                    <div class="stat-value">{{ stats.total_days }}</div>
                    <div class="stat-label">Total Travel Days</div>
                </div>
            </div>
        </div>
        
        <div class="row mb-4">
            <div class="col-md-6 mb-4">
                <div class="card h-100">
                    <div class="card-body">
                        <h4 class="card-title mb-4"><i class="fas fa-route me-2 text-primary"></i> Distance Traveled</h4>
                        
                        {% if home_address and stats.total_distance > 0 %}
                            <div class="display-4 mb-3">{{ "%.1f"|format(stats.total_distance|float) }} km</div>
                            <p class="text-muted mb-0">Total distance traveled from your home location</p>
                        {% else %}
                            <div class="alert alert-secondary">
                                <i class="fas fa-info-circle me-2"></i> Set your home location to calculate travel distances.
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            <div class="col-md-6 mb-4">
                <div class="card h-100">
                    <div class="card-body">
                        <h4 class="card-title mb-4"><i class="fas fa-money-bill-wave me-2 text-success"></i> Total Expenses</h4>
                        
                        {% if stats.total_cost > 0 %}
                            <div class="display-4 mb-3">${{ "%.2f"|format(stats.total_cost|float) }}</div>
                            <p class="text-muted mb-0">Total travel expenses across all trips</p>
                        {% else %}
                            <div class="alert alert-secondary">
                                <i class="fas fa-info-circle me-2"></i> Add costs to your travel plans to see expense statistics.
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Map and Expense Breakdown -->
        <div class="row mb-5">
            <div class="col-lg-8 mb-4">
                <div class="card h-100">
                    <div class="card-body">
                        <h4 class="card-title mb-4"><i class="fas fa-map me-2 text-primary"></i> Your Travel Map</h4>
                        
                        {% if home_address %}
                            <div id="statisticsMap" class="map-container"></div>
                        {% else %}
                            <div class="alert alert-secondary h-100 d-flex align-items-center justify-content-center">
                                <div class="text-center">
                                    <i class="fas fa-map-marker-alt fa-3x mb-3 text-muted"></i>
                                    <p>Set your home location to visualize your travel routes</p>
                                </div>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            <div class="col-lg-4 mb-4">
                <div class="card h-100">
                    <div class="card-body">
                        <h4 class="card-title mb-4"><i class="fas fa-chart-pie me-2 text-primary"></i> Expense Breakdown</h4>
                        
                        {% if stats.cost_breakdown %}
                            <ul class="list-group list-group-flush">
                                {% for category, amount in stats.cost_breakdown.items() %}
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        <span>{{ category }}</span>
                                        <span class="badge bg-primary rounded-pill">${{ "%.2f"|format(amount|float) }}</span>
                                    </li>
                                {% endfor %}
                            </ul>
                        {% else %}
                            <div class="alert alert-secondary">
                                <i class="fas fa-info-circle me-2"></i> Add costs to your travel plans to see expense breakdowns.
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
          <!-- Travel Summary and Smart Suggestions -->
        <div class="row">
            <div class="col-lg-7 mb-4">
                <div class="card h-100">
                    <div class="card-body">
                        <h4 class="card-title mb-4"><i class="fas fa-book-open me-2 text-primary"></i> Travel Summary</h4>
                        
                        {% if stats.total_trips > 0 %}
                            <div class="mb-4">
                                <h5>Exploration Summary</h5>
                                <p>
                                    You've embarked on <strong>{{ stats.total_trips }}</strong> adventures, 
                                    exploring <strong>{{ stats.visited_cities|length }}</strong> unique destinations
                                    across <strong>{{ stats.visited_countries|length }}</strong> countries.
                                    {% if stats.total_days > 0 %}
                                        Your journeys have taken you on the road for <strong>{{ stats.total_days }}</strong> days.
                                    {% endif %}
                                </p>
                            </div>
                            
                            {% if stats.visited_cities %}
                                <div class="mb-4">
                                    <h5>Cities Explored</h5>
                                    <div class="d-flex flex-wrap gap-2">
                                        {% for city in stats.visited_cities %}
                                            <span class="badge bg-primary-subtle text-primary">{{ city }}</span>
                                        {% endfor %}
                                    </div>
                                </div>
                            {% endif %}
                            
                            {% if stats.top_interests %}
                                <div class="mb-4">
                                    <h5>Top Interests</h5>
                                    <div class="d-flex flex-wrap gap-2">
                                        {% for interest in stats.top_interests %}
                                            <span class="badge bg-success-subtle text-success">{{ interest }}</span>
                                        {% endfor %}
                                    </div>
                                </div>
                            {% endif %}
                        {% else %}
                            <div class="alert alert-secondary">
                                <i class="fas fa-info-circle me-2"></i> Create travel plans to see your travel summary.
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            <div class="col-lg-5 mb-4">
                <div class="card h-100">
                    <div class="card-body">
                        <h4 class="card-title mb-4">
                            <i class="fas fa-lightbulb me-2 text-warning"></i> 
                            Smart Recommendations
                        </h4>
                        
                        <div id="recommendationsContainer">
                            <div class="text-center py-4">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <p class="mt-2">Generating personalized recommendations...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Home Location Modal -->
<div class="modal fade" id="homeLocationModal" tabindex="-1" aria-labelledby="homeLocationModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="homeLocationModalLabel">
                    <i class="fas fa-home me-2"></i> Set Home Location
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">                <p class="text-muted mb-4">Your home address is used to calculate travel distances and visualize routes. It is stored securely and only used within the app.</p>
                  <form id="homeLocationForm" method="post" action="{{ url_for('statistics.set_home_location') }}">
                    <!-- 不需要 CSRF token -->
                    <div class="mb-3 address-input-container">
                        <label for="address" class="form-label">Your Home Address</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="address" name="address" 
                                   placeholder="Enter your address, city, or region"
                                   value="{{ home_address }}" required>
                            <button class="btn btn-outline-primary" type="button" id="validateAddressBtn">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                        <div class="form-text">
                            Enter your address and click the search button to validate.
                        </div>
                        
                        <!-- Address suggestions will appear here -->
                        <div id="suggestions-container" class="d-none"></div>
                    </div>
                    
                    <!-- Hidden fields for the coordinates -->
                    <input type="hidden" id="lat" name="lat" value="{{ current_user.home_lat or '' }}">
                    <input type="hidden" id="lng" name="lng" value="{{ current_user.home_lng or '' }}">
                    
                    <div id="locationPreview" class="mb-3 d-none">
                        <label class="form-label">Location Preview</label>
                        <div id="previewMap" class="modal-map-container"></div>
                        
                        <div class="d-flex mt-2 text-muted small">
                            <div class="me-3">
                                <strong>Latitude:</strong> <span id="selectedLat"></span>
                            </div>
                            <div>
                                <strong>Longitude:</strong> <span id="selectedLng"></span>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveLocationBtn" disabled>
                    <i class="fas fa-check me-1"></i> Save Location
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Global variables to track initialization state
    let isInitialized = false;
    
    document.addEventListener('DOMContentLoaded', function() {
        // Prevent duplicate initialization
        if (isInitialized) return;
        isInitialized = true;
        
        // Initialize map if home address is set
        const homeAddress = {{ home_address|tojson|safe if home_address else 'null' }};
        
        if (homeAddress) {
            initializeStatisticsMap();
        }
        
        // Load recommendations
        fetchRecommendations('recommendationsContainer', '{{ url_for("statistics.get_ai_recommendations") }}');
        
        // Initialize location setting functionality
        initLocationSetting();
        
        // Initialize enhanced data visualizations
        initDataVisualizations();
    });
    
    function initializeStatisticsMap() {
        // Initialize map centered on home location
        const homeLocation = [{{ current_user.home_lat }}, {{ current_user.home_lng }}];
        const map = L.map('statisticsMap').setView(homeLocation, 4);
        
        // Add tile layer
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
            maxZoom: 19
        }).addTo(map);
        
        // Add home marker with custom icon
        const homeIcon = L.divIcon({
            className: 'custom-div-icon',
            html: `<div class="home-icon-container"><i class="fas fa-home home-icon"></i></div>`,
            iconSize: [30, 30],
            iconAnchor: [15, 15]
        });
        
        const homeMarker = L.marker(homeLocation, {
            icon: homeIcon,
            title: 'Home'
        }).addTo(map);
        homeMarker.bindPopup('<strong>Home Location</strong>');
        
        // Cache for destinations to prevent duplicate requests
        let destinationsCache = null;
        
        // Get actual destination coordinates from travel plans
        fetchDestinationCoordinates()
            .then(destinations => {
                destinationsCache = destinations;
                
                // Add destination markers
                destinations.forEach((destination, index) => {
                    if (destination.lat && destination.lng) {
                        const location = [destination.lat, destination.lng];
                        
                        // Create marker with custom icon color based on index
                        const colors = ['#4285f4', '#ea4335', '#fbbc05', '#34a853', '#8a2be2', '#00acc1', '#ff6d00'];
                        const color = colors[index % colors.length];
                        
                        const destinationIcon = L.divIcon({
                            className: 'custom-div-icon',
                            html: `<div style="background-color: ${color}; width: 12px; height: 12px; border-radius: 50%; border: 2px solid white;"></div>`,
                            iconSize: [12, 12],
                            iconAnchor: [6, 6]
                        });
                        
                        const marker = L.marker(location, {
                            icon: destinationIcon,
                            title: destination.name
                        }).addTo(map);
                        
                        marker.bindPopup(`<strong>${destination.name}</strong>`);
                        
                        // Draw curved route line from home to destination
                        drawCurvedRoute(map, homeLocation, location, color);
                    }
                });
                
                // Fit map to show all markers
                if (destinations.length > 0) {
                    const bounds = destinations
                        .filter(d => d.lat && d.lng)
                        .map(d => [d.lat, d.lng]);
                    
                    if (bounds.length > 0) {
                        bounds.push(homeLocation);
                        map.fitBounds(bounds);
                    }
                }
            })
            .catch(error => {
                console.error('Error fetching destination coordinates:', error);
            });
    }
    
    function fetchDestinationCoordinates() {
        // Prevent caching issues that might cause refreshes
        return fetch('{{ url_for("statistics.get_destinations") }}', {
            headers: {
                'Cache-Control': 'no-store',
                'Pragma': 'no-cache'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                return data.destinations;
            } else {
                throw new Error(data.message || 'Failed to fetch destinations');
            }
        });
    }
    
    function drawCurvedRoute(map, start, end, color) {
        // Create a curved path between two points for better visualization
        const offsetX = (end[1] - start[1]) * 0.125;
        const offsetY = (end[0] - start[0]) * 0.125;
        
        // The control point for the curve
        const control = [
            (start[0] + end[0]) / 2 + offsetY,
            (start[1] + end[1]) / 2 - offsetX
        ];
        
        // Generate points along the curve
        const points = [];
        // Start with the exact starting point
        points.push(start);
        
        // Generate intermediate points
        for (let t = 0.05; t < 0.95; t += 0.05) {
            points.push(bezierPoint(start, control, end, t));
        }
        
        // End with the exact destination point
        points.push(end);
        
        // Create polyline with the curved points
        L.polyline(points, {
            color: color || '#4285f4',
            weight: 2.5,
            opacity: 0.7,
            smoothFactor: 1
        }).addTo(map);
        
        // Add travel marker animation
        addTravelMarkerAnimation(map, points, color);
    }
    
    function bezierPoint(start, control, end, t) {
        // Quadratic Bezier curve formula
        const lat = Math.pow(1-t, 2) * start[0] + 
                    2 * (1-t) * t * control[0] + 
                    Math.pow(t, 2) * end[0];
        
        const lng = Math.pow(1-t, 2) * start[1] + 
                    2 * (1-t) * t * control[1] + 
                    Math.pow(t, 2) * end[1];
        
        return [lat, lng];
    }
    
    function addTravelMarkerAnimation(map, points, color) {
        // Create travel marker icon with the route color
        const travelMarkerIcon = L.divIcon({
            className: 'travel-marker-container',
            html: `<div class="travel-marker" style="border-color: ${color}"></div>`,
            iconSize: [12, 12],
            iconAnchor: [6, 6]
        });
        
        // Create travel marker
        const travelMarker = L.marker(points[0], {
            icon: travelMarkerIcon,
            interactive: false
        }).addTo(map);
        
        // Animate travel marker along the path
        let index = 0;
        const interval = setInterval(() => {
            if (index < points.length) {
                // Update travel marker position
                travelMarker.setLatLng(points[index]);
                
                index++;
            } else {
                clearInterval(interval);
                // Remove travel marker after journey completes
                setTimeout(() => map.removeLayer(travelMarker), 1000);
            }
        }, 50); // Speed up the animation by reducing interval time
    }
    
    function fetchRecommendations() {
        // Fetch AI recommendations
        fetch('{{ url_for("statistics.get_ai_recommendations") }}')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    renderRecommendations(data.recommendations);
                } else {
                    showRecommendationError();
                }
            })
            .catch(error => {
                console.error('Error fetching recommendations:', error);
                showRecommendationError();
            });
    }
    
    function renderRecommendations(recommendations) {
        const container = document.getElementById('recommendationsContainer');
        
        if (!recommendations || recommendations.length === 0) {
            container.innerHTML = `
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    Add more travel plans to receive personalized recommendations.
                </div>
            `;
            return;
        }
        
        let html = '';
        recommendations.forEach(rec => {
            // Set icon based on recommendation type
            let icon = 'lightbulb';
            if (rec.type === 'destination') icon = 'map-marker-alt';
            else if (rec.type === 'interest') icon = 'heart';
            else if (rec.type === 'habit') icon = 'calendar-check';
            
            html += `
                <div class="recommendation-card p-3 mb-3">
                    <h5 class="mb-2">
                        <i class="fas fa-${icon} me-2 text-primary"></i>
                        ${rec.title}
                    </h5>
                    <p class="mb-0">${rec.description}</p>
                </div>
            `;
        });
        
        container.innerHTML = html;
    }
    
    function showRecommendationError() {
        const container = document.getElementById('recommendationsContainer');
        container.innerHTML = `
            <div class="alert alert-warning">
                <i class="fas fa-exclamation-triangle me-2"></i>
                Unable to load recommendations. Please try again later.
            </div>
        `;
    }
    
    // Home location setting functionality
    function initLocationSetting() {
        const addressInput = document.getElementById('address');
        const validateBtn = document.getElementById('validateAddressBtn');
        const suggestionsContainer = document.getElementById('suggestions-container');
        const saveLocationBtn = document.getElementById('saveLocationBtn');
        const homeLocationForm = document.getElementById('homeLocationForm');
        const homeLocationModal = document.getElementById('homeLocationModal');
        let previewMap = null;
        let previewMarker = null;
        let debounceTimer;
        
        // Initialize map when modal is shown using Bootstrap 5 event listener
        homeLocationModal.addEventListener('shown.bs.modal', function() {
            if (!previewMap) {
                previewMap = L.map('previewMap').setView([0, 0], 2);
                
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                    maxZoom: 19
                }).addTo(previewMap);
                
                // If we already have coordinates, show them
                const lat = document.getElementById('lat').value;
                const lng = document.getElementById('lng').value;
                
                if (lat && lng) {
                    showLocationOnMap(parseFloat(lat), parseFloat(lng), addressInput.value);
                }
            }
            
            // Force map to recalculate size after modal is fully visible
            setTimeout(function() {
                previewMap.invalidateSize();
            }, 200);
        });
        
        // Handle validate button click
        validateBtn.addEventListener('click', function() {
            const query = addressInput.value.trim();
            
            if (query.length > 0) {
                fetchAddressSuggestions(query);
            }
        });
        
        // Handle address input (debounced)
        addressInput.addEventListener('input', function() {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => {
                const query = this.value.trim();
                
                if (query.length >= 3) {
                    fetchAddressSuggestions(query);
                } else {
                    suggestionsContainer.innerHTML = '';
                    suggestionsContainer.classList.add('d-none');
                }
                
                // Disable save button until address is validated
                saveLocationBtn.disabled = true;
            }, 500);
        });
        
        // Handle save button click
        saveLocationBtn.addEventListener('click', function() {
            homeLocationForm.submit();
        });
        
        // Fetch address suggestions
        function fetchAddressSuggestions(query) {
            // Show loading state
            suggestionsContainer.innerHTML = '<div class="address-suggestion text-center"><div class="spinner-border spinner-border-sm me-2" role="status"></div> 搜索中...</div>';
            suggestionsContainer.classList.remove('d-none');
            
            // Call Nominatim API
            fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=5`)
                .then(response => response.json())
                .then(data => {
                    if (data && data.length > 0) {
                        renderSuggestions(data);
                    } else {
                        suggestionsContainer.innerHTML = '<div class="address-suggestion text-center">未找到结果</div>';
                    }
                })
                .catch(error => {
                    console.error('Error fetching address suggestions:', error);
                    suggestionsContainer.innerHTML = '<div class="address-suggestion text-center text-danger">搜索地址时出错</div>';
                });
        }
        
        // Render suggestions
        function renderSuggestions(suggestions) {
            suggestionsContainer.innerHTML = '';
            
            suggestions.forEach(suggestion => {
                const div = document.createElement('div');
                div.className = 'address-suggestion';
                div.textContent = suggestion.display_name;
                
                // Store the coordinates as data attributes
                div.dataset.lat = suggestion.lat;
                div.dataset.lng = suggestion.lon;
                div.dataset.name = suggestion.display_name;
                
                div.addEventListener('click', function() {
                    // Set the input value
                    addressInput.value = this.dataset.name;
                    
                    // Set the hidden inputs
                    document.getElementById('lat').value = this.dataset.lat;
                    document.getElementById('lng').value = this.dataset.lng;
                    
                    // Show location on map
                    showLocationOnMap(
                        parseFloat(this.dataset.lat), 
                        parseFloat(this.dataset.lng),
                        this.dataset.name
                    );
                    
                    // Hide suggestions
                    suggestionsContainer.classList.add('d-none');
                    
                    // Enable save button
                    saveLocationBtn.disabled = false;
                });
                
                suggestionsContainer.appendChild(div);
            });
        }
        
        // Show selected location on the map
        function showLocationOnMap(lat, lng, address) {
            // Show the map container
            document.getElementById('locationPreview').classList.remove('d-none');
            
            // Update the map
            previewMap.setView([lat, lng], 13);
            
            // Remove existing marker if any
            if (previewMarker) {
                previewMap.removeLayer(previewMarker);
            }
            
            // Add a new marker
            previewMarker = L.marker([lat, lng]).addTo(previewMap);
            previewMarker.bindPopup(`<strong>已选位置</strong><br>${address}`).openPopup();
            
            // Update the coordinates display
            document.getElementById('selectedLat').textContent = lat.toFixed(6);
            document.getElementById('selectedLng').textContent = lng.toFixed(6);
        }
    }
</script>
{% endblock %}

<!-- Enhanced Data Analysis Sections -->
<section class="py-4">
    <div class="container">
        <h2 class="mb-4">Advanced Travel Insights</h2>
        
        <!-- Travel Timeline -->
        <div class="row mb-5">
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        <h4 class="card-title mb-4"><i class="fas fa-stream me-2 text-primary"></i> Your Travel Timeline</h4>
                        <div id="travelTimeline" data-source="{{ url_for('statistics.get_travel_timeline') }}">
                            <div class="text-center py-4">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <p class="mt-2">Loading your travel timeline...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Expense Chart and Destination Comparison -->
        <div class="row mb-5">
            <div class="col-lg-6 mb-4">
                <div class="card h-100">
                    <div class="card-body">
                        <h4 class="card-title mb-4"><i class="fas fa-chart-pie me-2 text-primary"></i> Expense Visualization</h4>
                        
                        {% if stats.cost_breakdown %}
                            <div id="expenseChart"
                                data-categories='{{ stats.cost_breakdown.keys()|list|tojson }}'
                                data-values='{{ stats.cost_breakdown.values()|list|tojson }}'>
                                <div class="text-center py-4">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                    <p class="mt-2">Generating expense chart...</p>
                                </div>
                            </div>
                        {% else %}
                            <div class="alert alert-secondary">
                                <i class="fas fa-info-circle me-2"></i> Add costs to your travel plans to see expense visualizations.
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            <div class="col-lg-6 mb-4">
                <div class="card h-100">
                    <div class="card-body">
                        <h4 class="card-title mb-4"><i class="fas fa-chart-radar me-2 text-primary"></i> Destination Comparison</h4>
                        <div id="destinationComparison" data-source="{{ url_for('statistics.get_destination_comparison') }}">
                            <div class="text-center py-4">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <p class="mt-2">Analyzing your destinations...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Travel Trend Analysis and Heat Map -->
        <div class="row mb-5">
            <div class="col-lg-6 mb-4">
                <div class="card h-100">
                    <div class="card-body">
                        <h4 class="card-title mb-4"><i class="fas fa-chart-line me-2 text-primary"></i> Travel Trends</h4>
                        <div id="trendAnalysis" data-source="{{ url_for('statistics.get_trend_analysis') }}">
                            <div class="text-center py-4">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <p class="mt-2">Analyzing your travel trends...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-6 mb-4">
                <div class="card h-100">
                    <div class="card-body">
                        <h4 class="card-title mb-4"><i class="fas fa-globe me-2 text-primary"></i> Travel Heatmap</h4>
                        {% if home_address %}
                            <div id="travelHeatmap" class="map-container"></div>
                        {% else %}
                            <div class="alert alert-secondary">
                                <i class="fas fa-info-circle me-2"></i> Set your home location to view travel intensity heatmap.
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>